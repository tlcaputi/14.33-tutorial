<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Poll - Presenter</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header with join code */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .session-name {
            font-size: 1.5rem;
            font-weight: 300;
        }

        .join-info {
            text-align: right;
        }

        .join-url {
            font-size: 1rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 0.25rem;
        }

        .join-code {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 0.3rem;
            color: #4ade80;
            font-family: 'Courier New', monospace;
        }

        /* Question display */
        .question-container {
            background: rgba(255,255,255,0.05);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .question-number {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 2rem;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 1.5rem;
        }

        .response-count {
            font-size: 1rem;
            color: rgba(255,255,255,0.6);
        }

        .response-count span {
            font-weight: 700;
            color: #4ade80;
        }

        /* Results bar chart */
        .results-container {
            margin-top: 2rem;
        }

        .result-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .result-label {
            width: 120px;
            font-size: 1.1rem;
            font-weight: 500;
            flex-shrink: 0;
        }

        .result-bar-container {
            flex: 1;
            height: 50px;
            background: rgba(255,255,255,0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            margin: 0 1rem;
        }

        .result-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
            border-radius: 0.5rem;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            padding-left: 1rem;
            min-width: 0;
        }

        .result-bar.correct {
            background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
        }

        .result-bar.incorrect {
            background: linear-gradient(90deg, #f87171 0%, #ef4444 100%);
        }

        .result-count {
            width: 80px;
            text-align: right;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .result-percent {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.6);
        }

        /* Word cloud */
        .word-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 2rem;
        }

        .word-cloud-item {
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid rgba(74, 222, 128, 0.4);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-size: 1.25rem;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4ade80;
            color: #1a1a2e;
        }

        .btn-primary:hover {
            background: #22c55e;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Question list sidebar */
        .question-list {
            background: rgba(255,255,255,0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .question-list h3 {
            font-size: 1rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05rem;
        }

        .question-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .question-item.active {
            background: rgba(74, 222, 128, 0.2);
            border-left: 3px solid #4ade80;
        }

        .question-item-num {
            font-weight: 700;
            margin-right: 0.75rem;
            color: rgba(255,255,255,0.5);
        }

        .question-item-votes {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.4);
        }

        /* Setup screen */
        .setup-screen {
            max-width: 500px;
            margin: 4rem auto;
            text-align: center;
        }

        .setup-screen h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .setup-screen p {
            color: rgba(255,255,255,0.6);
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            text-align: left;
            margin-bottom: 0.5rem;
            color: rgba(255,255,255,0.8);
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1rem;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4ade80;
        }

        .session-list {
            margin-top: 2rem;
            text-align: left;
        }

        .session-list h3 {
            margin-bottom: 1rem;
            color: rgba(255,255,255,0.6);
        }

        .session-item {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .session-item:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Waiting for responses */
        .waiting {
            text-align: center;
            padding: 4rem 2rem;
            color: rgba(255,255,255,0.6);
        }

        .waiting .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Reveal answer styling */
        .answer-revealed .result-bar {
            background: linear-gradient(90deg, #6b7280 0%, #4b5563 100%);
        }

        .answer-revealed .result-bar.correct {
            background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Setup Screen -->
        <div class="setup-screen" id="setup-screen">
            <h1>Classroom Polls</h1>
            <p>Create a new session or load an existing one</p>

            <div class="input-group">
                <label>Session Name</label>
                <input type="text" id="session-name" placeholder="e.g., Stata Tutorial Quiz 1">
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="createSession()">
                Create New Session
            </button>

            <div class="session-list" id="session-list">
                <h3>Or load existing session:</h3>
                <div id="existing-sessions">Loading...</div>
            </div>
        </div>

        <!-- Presenter Screen -->
        <div id="presenter-screen" style="display: none;">
            <div class="header">
                <div class="session-name" id="display-session-name">Session Name</div>
                <div class="join-info">
                    <div class="join-url">Join at: <strong id="student-url">student.html</strong></div>
                    <div class="join-code" id="display-code">ABC123</div>
                </div>
            </div>

            <div class="question-container" id="question-container">
                <div class="waiting" id="no-question">
                    <p>Select a question from the list below to display it</p>
                </div>
                <div id="active-question" style="display: none;">
                    <div class="question-number" id="question-number">Question 1 of 4</div>
                    <div class="question-text" id="question-text">Question text here</div>
                    <div class="response-count">
                        <span id="vote-count">0</span> responses
                    </div>
                    <div class="results-container" id="results-container"></div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-secondary" onclick="prevQuestion()" id="prev-btn">← Previous</button>
                <button class="btn btn-primary" onclick="nextQuestion()" id="next-btn">Next →</button>
                <button class="btn btn-secondary" onclick="toggleResults()" id="toggle-results-btn">Show Results</button>
                <button class="btn btn-secondary" onclick="revealAnswer()" id="reveal-btn">Reveal Answer</button>
                <button class="btn btn-secondary" onclick="showSetup()">← Back to Sessions</button>
            </div>

            <div class="question-list">
                <h3>Questions</h3>
                <div id="question-list-items"></div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // CONFIGURATION - Update these with your Supabase credentials
        // =====================================================================
        const SUPABASE_URL = 'https://zhuhmafxfbynydonogux.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpodWhtYWZ4ZmJ5bnlkb25vZ3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNTgwOTgsImV4cCI6MjA4NTczNDA5OH0.8cTwykaV2YI-2oTnfe4eP4PmMIrZHE8SuJzA8afuLDQ';

        // Initialize Supabase client
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =====================================================================
        // State
        // =====================================================================
        let currentSession = null;
        let questions = [];
        let currentQuestionIndex = -1;
        let votes = {};
        let showingResults = false;
        let answerRevealed = false;

        // =====================================================================
        // Initialization
        // =====================================================================
        async function init() {
            await loadExistingSessions();
        }

        async function loadExistingSessions() {
            const { data, error } = await db
                .from('sessions')
                .select('*')
                .eq('is_active', true)
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('existing-sessions').innerHTML = '<p>Error loading sessions</p>';
                return;
            }

            if (data.length === 0) {
                document.getElementById('existing-sessions').innerHTML = '<p style="color: rgba(255,255,255,0.4)">No existing sessions</p>';
                return;
            }

            document.getElementById('existing-sessions').innerHTML = data.map(session => `
                <div class="session-item" onclick="loadSession('${session.id}')">
                    <strong>${session.name}</strong>
                    <div style="font-size: 0.875rem; color: rgba(255,255,255,0.5);">
                        Code: ${session.code} • Created: ${new Date(session.created_at).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        // =====================================================================
        // Session Management
        // =====================================================================
        async function createSession() {
            const name = document.getElementById('session-name').value.trim();
            if (!name) {
                alert('Please enter a session name');
                return;
            }

            // Generate a random code
            const code = generateCode();

            const { data, error } = await db
                .from('sessions')
                .insert([{ name, code }])
                .select()
                .single();

            if (error) {
                console.error('Error creating session:', error);
                alert('Error creating session. Check console for details.');
                return;
            }

            await loadSession(data.id);
        }

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        async function loadSession(sessionId) {
            const { data: session, error: sessionError } = await db
                .from('sessions')
                .select('*')
                .eq('id', sessionId)
                .single();

            if (sessionError) {
                console.error('Error loading session:', sessionError);
                return;
            }

            currentSession = session;

            // Load questions
            const { data: questionData, error: questionError } = await db
                .from('questions')
                .select('*')
                .eq('session_id', sessionId)
                .order('order_num');

            if (questionError) {
                console.error('Error loading questions:', questionError);
            }

            questions = questionData || [];

            // Update UI
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('presenter-screen').style.display = 'block';
            document.getElementById('display-session-name').textContent = session.name;
            document.getElementById('display-code').textContent = session.code;

            // Set student URL
            const studentUrl = window.location.href.replace('presenter.html', 'student.html');
            document.getElementById('student-url').textContent = studentUrl.split('/').pop();

            renderQuestionList();
            subscribeToVotes();

            // If there's an active question, show it
            if (session.active_question_id) {
                const idx = questions.findIndex(q => q.id === session.active_question_id);
                if (idx >= 0) {
                    showQuestion(idx);
                }
            }
        }

        function showSetup() {
            document.getElementById('setup-screen').style.display = 'block';
            document.getElementById('presenter-screen').style.display = 'none';
            currentSession = null;
            questions = [];
            currentQuestionIndex = -1;
        }

        // =====================================================================
        // Question Display
        // =====================================================================
        function renderQuestionList() {
            const container = document.getElementById('question-list-items');

            if (questions.length === 0) {
                container.innerHTML = `
                    <p style="color: rgba(255,255,255,0.4); padding: 1rem;">
                        No questions yet. Use the Python script to add questions.
                    </p>
                `;
                return;
            }

            container.innerHTML = questions.map((q, idx) => `
                <div class="question-item ${idx === currentQuestionIndex ? 'active' : ''}"
                     onclick="showQuestion(${idx})">
                    <div>
                        <span class="question-item-num">Q${idx + 1}</span>
                        ${q.question_text.substring(0, 50)}${q.question_text.length > 50 ? '...' : ''}
                    </div>
                    <span class="question-item-votes" id="q-votes-${idx}">0 votes</span>
                </div>
            `).join('');
        }

        async function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;

            currentQuestionIndex = index;
            const question = questions[index];
            showingResults = false;
            answerRevealed = false;

            // Update active question in database
            await db
                .from('sessions')
                .update({ active_question_id: question.id })
                .eq('id', currentSession.id);

            // Update UI
            document.getElementById('no-question').style.display = 'none';
            document.getElementById('active-question').style.display = 'block';
            document.getElementById('question-number').textContent =
                `Question ${index + 1} of ${questions.length}`;
            document.getElementById('question-text').textContent = question.question_text;
            document.getElementById('toggle-results-btn').textContent = 'Show Results';
            document.getElementById('results-container').classList.remove('answer-revealed');

            // Show/hide reveal button based on whether there's a correct answer
            document.getElementById('reveal-btn').style.display =
                question.correct_answer ? 'inline-block' : 'none';

            // Render results container based on question type
            renderResults(question);

            // Update question list highlighting
            renderQuestionList();

            // Load existing votes
            await loadVotes(question.id);

            // Update button states
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === questions.length - 1;
        }

        function renderResults(question) {
            const container = document.getElementById('results-container');

            if (question.question_type === 'multiple_choice') {
                const options = question.options || [];
                container.innerHTML = options.map((opt, idx) => `
                    <div class="result-row">
                        <div class="result-label">${String.fromCharCode(65 + idx)})</div>
                        <div class="result-bar-container">
                            <div class="result-bar" id="bar-${idx}" style="width: 0%" data-option="${opt}"></div>
                        </div>
                        <div class="result-count">
                            <span id="count-${idx}">0</span>
                            <div class="result-percent" id="percent-${idx}">0%</div>
                        </div>
                    </div>
                `).join('');
                container.style.display = showingResults ? 'block' : 'none';
            } else if (question.question_type === 'word_cloud') {
                container.innerHTML = '<div class="word-cloud" id="word-cloud"></div>';
                container.style.display = 'block';
            } else {
                container.innerHTML = '<div id="open-responses"></div>';
                container.style.display = 'block';
            }
        }

        function toggleResults() {
            showingResults = !showingResults;
            const container = document.getElementById('results-container');
            const btn = document.getElementById('toggle-results-btn');

            if (showingResults) {
                container.style.display = 'block';
                btn.textContent = 'Hide Results';
            } else {
                container.style.display = 'none';
                btn.textContent = 'Show Results';
            }
        }

        function revealAnswer() {
            if (currentQuestionIndex < 0) return;

            const question = questions[currentQuestionIndex];
            if (!question.correct_answer) return;

            answerRevealed = true;
            showingResults = true;
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('results-container').classList.add('answer-revealed');
            document.getElementById('toggle-results-btn').textContent = 'Hide Results';

            // Highlight correct answer
            const options = question.options || [];
            options.forEach((opt, idx) => {
                const bar = document.getElementById(`bar-${idx}`);
                if (bar) {
                    if (opt === question.correct_answer) {
                        bar.classList.add('correct');
                        bar.classList.remove('incorrect');
                    } else {
                        bar.classList.add('incorrect');
                        bar.classList.remove('correct');
                    }
                }
            });
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        }

        // =====================================================================
        // Vote Handling
        // =====================================================================
        async function loadVotes(questionId) {
            const { data, error } = await db
                .from('votes')
                .select('*')
                .eq('question_id', questionId);

            if (error) {
                console.error('Error loading votes:', error);
                return;
            }

            votes[questionId] = data || [];
            updateVoteDisplay();
        }

        function subscribeToVotes() {
            db
                .channel('votes-channel')
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'votes' },
                    (payload) => {
                        const vote = payload.new;
                        if (!votes[vote.question_id]) {
                            votes[vote.question_id] = [];
                        }
                        votes[vote.question_id].push(vote);
                        updateVoteDisplay();
                    }
                )
                .subscribe();
        }

        function updateVoteDisplay() {
            if (currentQuestionIndex < 0) return;

            const question = questions[currentQuestionIndex];
            const questionVotes = votes[question.id] || [];

            document.getElementById('vote-count').textContent = questionVotes.length;

            if (question.question_type === 'multiple_choice') {
                updateBarChart(question, questionVotes);
            } else if (question.question_type === 'word_cloud') {
                updateWordCloud(questionVotes);
            } else {
                updateOpenResponses(questionVotes);
            }

            // Update question list vote counts
            questions.forEach((q, idx) => {
                const voteCount = (votes[q.id] || []).length;
                const el = document.getElementById(`q-votes-${idx}`);
                if (el) el.textContent = `${voteCount} votes`;
            });
        }

        function updateBarChart(question, questionVotes) {
            const options = question.options || [];
            const counts = {};
            options.forEach(opt => counts[opt] = 0);

            questionVotes.forEach(vote => {
                if (counts.hasOwnProperty(vote.response)) {
                    counts[vote.response]++;
                }
            });

            const total = questionVotes.length || 1;
            const maxCount = Math.max(...Object.values(counts), 1);

            options.forEach((opt, idx) => {
                const count = counts[opt];
                const percent = Math.round((count / total) * 100);
                const barWidth = Math.round((count / maxCount) * 100);

                const bar = document.getElementById(`bar-${idx}`);
                const countEl = document.getElementById(`count-${idx}`);
                const percentEl = document.getElementById(`percent-${idx}`);

                if (bar) bar.style.width = `${barWidth}%`;
                if (countEl) countEl.textContent = count;
                if (percentEl) percentEl.textContent = `${percent}%`;
            });
        }

        function updateWordCloud(questionVotes) {
            const container = document.getElementById('word-cloud');
            if (!container) return;

            // Count word frequencies
            const wordCounts = {};
            questionVotes.forEach(vote => {
                const word = vote.response.trim().toLowerCase();
                if (word) {
                    wordCounts[word] = (wordCounts[word] || 0) + 1;
                }
            });

            // Sort by frequency
            const sortedWords = Object.entries(wordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 30);

            container.innerHTML = sortedWords.map(([word, count]) => {
                const size = Math.min(2, 1 + count * 0.2);
                return `<span class="word-cloud-item" style="font-size: ${size}rem">${word}</span>`;
            }).join('');
        }

        function updateOpenResponses(questionVotes) {
            const container = document.getElementById('open-responses');
            if (!container) return;

            container.innerHTML = questionVotes.map(vote => `
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    ${vote.response}
                </div>
            `).join('');
        }

        // Initialize
        init();
    </script>
</body>
</html>
