---
layout: layouts/tutorial.html
title: Causal Inference | Intro to Data Analysis for Economics
current_page: causal-inference
---
<h1>Causal Inference</h1>
<p class="subtitle">From naive comparisons to credible research designs</p>

<section id="the-question" class="tutorial-section">
  <h2>The Question</h2>

  <p>Let's start with a simple question: <strong>Does going to MIT affect wages?</strong></p>

  <p>This seems straightforward. Just compare people who went to MIT to people who didn't, right? Unfortunately, it's much harder than it sounds. Let's work through why.</p>

  {% capture kp_content %}
    <p>We want to know: if we took a specific person and randomly chose whether they attend MIT or not, how would their wages differ? This is fundamentally different from asking how MIT graduates compare to non-MIT graduates.</p>
  {% endcapture %}
  {% include "key-principle.liquid", title: "The Goal of Causal Inference", content: kp_content %}
</section>

<section id="potential-outcomes" class="tutorial-section">
  <h2>The Potential Outcomes Framework</h2>

  <p>To think clearly about causation, we need to formalize what we mean by a "treatment effect."</p>

  <h3>Two Potential Worlds</h3>

  <p>For any individual, consider two hypothetical scenarios:</p>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 20px 0;">
    <div style="background: #e8f5e9; border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
      <h4 style="margin-top: 0; color: #27ae60;">Y(1): Outcome if Treated</h4>
      <p style="margin-bottom: 0;">Sarah's wages if she attends MIT</p>
    </div>
    <div style="background: #fff3e0; border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
      <h4 style="margin-top: 0; color: #f39c12;">Y(0): Outcome if Not Treated</h4>
      <p style="margin-bottom: 0;">Sarah's wages if she doesn't attend MIT</p>
    </div>
  </div>

  <p>The <strong>causal effect</strong> for Sarah is: Y(1) - Y(0)</p>

  {% capture kp_content %}
    <p>We can never observe both Y(1) and Y(0) for the same person. Sarah either goes to MIT or she doesn't. We observe one reality, not both. The unobserved outcome is called the <strong>counterfactual</strong>.</p>
  {% endcapture %}
  {% include "key-principle.liquid", title: "The Fundamental Problem", content: kp_content %}

  <h3>Example: Sarah's Potential Outcomes</h3>

  <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
    <thead>
      <tr style="background: var(--bg-subtle);">
        <th style="padding: 12px; text-align: left; border: 1px solid var(--border);">Scenario</th>
        <th style="padding: 12px; text-align: center; border: 1px solid var(--border);">Y(1): MIT</th>
        <th style="padding: 12px; text-align: center; border: 1px solid var(--border);">Y(0): No MIT</th>
        <th style="padding: 12px; text-align: center; border: 1px solid var(--border);">Effect</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="padding: 12px; border: 1px solid var(--border);">Sarah (attended MIT)</td>
        <td style="padding: 12px; text-align: center; border: 1px solid var(--border);">$120,000 <em>(observed)</em></td>
        <td style="padding: 12px; text-align: center; border: 1px solid var(--border); color: var(--muted);">??? <em>(counterfactual)</em></td>
        <td style="padding: 12px; text-align: center; border: 1px solid var(--border);">???</td>
      </tr>
    </tbody>
  </table>

  <p>If Sarah had the same ability and work ethic, but went to a state school instead, would she earn $100,000? $80,000? $120,000? We simply don't know.</p>

  <h3>Average Treatment Effect</h3>

  <p>Since we can't measure individual effects, we focus on averages across many people:</p>

  <ul>
    <li><strong>ATE</strong> = E[Y(1) - Y(0)] = Average effect for everyone</li>
    <li><strong>ATT</strong> = E[Y(1) - Y(0) | D=1] = Average effect on those who actually got treated</li>
  </ul>
</section>

<section id="naive-approaches" class="tutorial-section">
  <h2>Naive Approaches (That Fail)</h2>

  <p>Before diving into solutions, let's understand why the obvious approaches don't work.</p>

  <h3>Approach 1: Before vs. After</h3>

  <p>Compare wages while at MIT vs. after graduation:</p>

  <div style="background: var(--bg-subtle); padding: 20px; border-radius: 8px; margin: 20px 0;">
    <p style="margin: 0;"><strong>Wages during MIT:</strong> ~$0 (undergrads don't get paid)</p>
    <p style="margin: 0;"><strong>Wages after MIT:</strong> ~$85,000</p>
    <p style="margin: 0; color: var(--primary);"><strong>"Effect" of MIT:</strong> +$85,000!</p>
  </div>

  {% capture cm_content %}
    <p>This comparison conflates the effect of MIT with the effect of <em>time</em> (aging, gaining experience, entering the labor market). Anyone's wages would increase from college to post-graduation, regardless of where they went to school.</p>
  {% endcapture %}
  {% include "common-mistake.liquid", title: "Why This Fails", content: cm_content %}

  <h3>Approach 2: MIT Grads vs. Non-MIT Grads</h3>

  <p>Compare wages of MIT graduates to wages of people who didn't go to MIT:</p>

  <div style="background: var(--bg-subtle); padding: 20px; border-radius: 8px; margin: 20px 0;">
    <p style="margin: 0;"><strong>MIT graduates:</strong> ~$125,000 average salary</p>
    <p style="margin: 0;"><strong>Non-MIT graduates:</strong> ~$65,000 average salary</p>
    <p style="margin: 0; color: var(--primary);"><strong>"Effect" of MIT:</strong> +$60,000!</p>
  </div>

  {% capture cm_content %}
    <p>MIT students aren't a random sample. They're selected based on high test scores, strong work ethic, ambitious personalities, wealthy family backgrounds, etc. These same traits would lead to higher wages <em>even without MIT</em>. We can't tell how much of the $60,000 gap is MIT vs. pre-existing differences.</p>
  {% endcapture %}
  {% include "common-mistake.liquid", title: "Why This Fails: Selection Bias", content: cm_content %}

  <!-- Visual: Selection Bias Diagram -->
  <div style="margin: 30px 0; text-align: center;">
    <svg viewBox="0 0 500 200" style="max-width: 500px; width: 100%;">
      <!-- Ability box -->
      <rect x="200" y="10" width="100" height="40" fill="#f8f9fa" stroke="#750014" stroke-width="2" rx="4"/>
      <text x="250" y="35" text-anchor="middle" font-size="12" fill="#333">Ability, Work Ethic,</text>
      <text x="250" y="48" text-anchor="middle" font-size="10" fill="#666">Family Background</text>

      <!-- Arrows from ability -->
      <line x1="200" y1="50" x2="100" y2="90" stroke="#750014" stroke-width="2" marker-end="url(#arrowhead)"/>
      <line x1="300" y1="50" x2="400" y2="90" stroke="#750014" stroke-width="2" marker-end="url(#arrowhead)"/>

      <!-- MIT box -->
      <rect x="50" y="90" width="100" height="40" fill="#e8f5e9" stroke="#27ae60" stroke-width="2" rx="4"/>
      <text x="100" y="115" text-anchor="middle" font-size="12" fill="#333">MIT Attendance</text>

      <!-- Wages box -->
      <rect x="350" y="90" width="100" height="40" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="4"/>
      <text x="400" y="115" text-anchor="middle" font-size="12" fill="#333">Wages</text>

      <!-- Arrow from MIT to Wages -->
      <line x1="150" y1="110" x2="350" y2="110" stroke="#27ae60" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead-green)"/>
      <text x="250" y="100" text-anchor="middle" font-size="10" fill="#27ae60">Causal effect (what we want)</text>

      <!-- Labels for confounding paths -->
      <text x="120" y="70" text-anchor="middle" font-size="9" fill="#750014">Selection into</text>
      <text x="120" y="80" text-anchor="middle" font-size="9" fill="#750014">treatment</text>
      <text x="380" y="70" text-anchor="middle" font-size="9" fill="#750014">Direct effect</text>
      <text x="380" y="80" text-anchor="middle" font-size="9" fill="#750014">on outcome</text>

      <!-- Arrow definitions -->
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#750014"/>
        </marker>
        <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#27ae60"/>
        </marker>
      </defs>
    </svg>
    <p style="font-size: 0.85rem; color: var(--muted); margin-top: 8px;">The problem: ability affects both MIT attendance AND wages directly</p>
  </div>

  <h3>Approach 3: "Controlling For" Observables</h3>

  <p>A natural response: "What if we compare people with the <em>same</em> SAT scores? Then we're holding ability constant."</p>

  {% capture sc %}* "Controlling for" SAT score
reg wages attended_mit sat_score{% endcapture %}
  {% capture rc %}# "Controlling for" SAT score
lm(wages ~ attended_mit + sat_score, data = df){% endcapture %}
  {% capture pc %}# "Controlling for" SAT score
import statsmodels.formula.api as smf
model = smf.ols('wages ~ attended_mit + sat_score', data=df).fit(){% endcapture %}
  {% include "code-block.liquid", stata: sc, r: rc, python: pc %}

  {% capture cm_content %}
    <p>Even among people with identical SAT scores, MIT students are <em>systematically different</em> from non-MIT students:</p>
    <ul>
      <li><strong>Who applies:</strong> A student with a 1550 SAT who applies to MIT has different ambitions than someone with a 1550 who doesn't apply</li>
      <li><strong>Who gets in:</strong> MIT admits students based on essays, recommendations, extracurriculars—all things correlated with future success</li>
      <li><strong>Who attends:</strong> Among admits, those who choose MIT over Harvard or Stanford may be different in unobservable ways</li>
    </ul>
  {% endcapture %}
  {% include "common-mistake.liquid", title: "Why This Still Fails", content: cm_content %}

  <p>Consider two students who both scored 1520 on the SAT:</p>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 20px 0;">
    <div style="background: #e8f5e9; border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
      <h4 style="margin-top: 0; color: #27ae60;">Alice (MIT)</h4>
      <ul style="margin-bottom: 0; font-size: 0.9rem;">
        <li>Founded a robotics club</li>
        <li>Published research in high school</li>
        <li>Family values elite education</li>
        <li>Strong peer network</li>
      </ul>
    </div>
    <div style="background: #fff3e0; border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
      <h4 style="margin-top: 0; color: #f39c12;">Bob (State School)</h4>
      <ul style="margin-bottom: 0; font-size: 0.9rem;">
        <li>Got a high SAT score but didn't apply</li>
        <li>Preferred staying close to home</li>
        <li>Less focused on prestige</li>
        <li>Different career aspirations</li>
      </ul>
    </div>
  </div>

  <p>Same SAT score, but Alice would likely earn more than Bob <em>regardless of where they went to college</em>. The things that made Alice apply to and attend MIT are the same things that will make her successful in her career.</p>

  {% capture kp_content %}
    <p>You can only control for things you can measure. But the decision to attend MIT is driven by motivation, ambition, family expectations, risk tolerance, career goals—most of which we can't observe. Adding more controls helps, but can never fully solve the problem.</p>
  {% endcapture %}
  {% include "key-principle.liquid", title: "Selection on Unobservables", content: kp_content %}
</section>

<section id="random-assignment" class="tutorial-section">
  <h2>The Gold Standard: Random Assignment</h2>

  <p>What if we could randomly assign students to MIT vs. other schools?</p>

  {% capture callout_content %}
    <strong>Why randomization works:</strong> If treatment is randomly assigned, then on average, the treated and control groups are identical in all characteristics (observed and unobserved). Any difference in outcomes must be due to treatment.
  {% endcapture %}
  {% include "callout.liquid", type: "success", content: callout_content %}

  <h3>Why We Can't Randomize MIT Attendance</h3>

  <p>MIT is selective, and nobody is going to let us randomly assign students to go there. This is why we need <strong>quasi-experimental methods</strong>—strategies that approximate random assignment using naturally occurring variation.</p>
</section>

<section id="did" class="tutorial-section">
  <h2>Difference-in-Differences (DiD)</h2>

  <p>DiD is the workhorse of applied microeconomics. The idea: compare <em>changes over time</em> between treated and control groups.</p>

  {% capture callout_content %}
    <h4 style="margin-top: 0; color: #27ae60;">Recommendation for 14.33</h4>
    <p style="margin-bottom: 0;"><strong>For your research project, I recommend a difference-in-differences approach.</strong> Here's why:</p>
    <ul style="margin-bottom: 0;">
      <li><strong>Straightforward analysis:</strong> The regression setup is intuitive and easy to implement</li>
      <li><strong>Testable assumptions:</strong> You can validate parallel trends by examining pre-treatment periods</li>
      <li><strong>Flexible data requirements:</strong> Many different kinds of panel data can support a DiD design</li>
      <li><strong>This is real economics:</strong> DiD is the bread and butter of applied micro—professors at top schools publish DiD papers in top journals all the time</li>
    </ul>
  {% endcapture %}
  {% include "callout.liquid", type: "success", content: callout_content %}

  <h3>The Setup</h3>

  <p>Suppose we want to estimate the effect of raising the minimum wage on employment. Some states raised their minimum wage in 2015, while neighboring states kept theirs the same:</p>

  <ul>
    <li><strong>Treatment group:</strong> States that raised the minimum wage</li>
    <li><strong>Control group:</strong> States that didn't raise it</li>
    <li><strong>Before period:</strong> Employment before the policy change</li>
    <li><strong>After period:</strong> Employment after the policy change</li>
  </ul>

  <h3>The DiD Estimator</h3>

  <div class="equation-box">
    <p style="margin: 0; font-size: 1.1em;">
      DiD = [Y<sub>treatment,after</sub> - Y<sub>treatment,before</sub>] - [Y<sub>control,after</sub> - Y<sub>control,before</sub>]
    </p>
  </div>

  <!-- DiD Visual -->
  <div style="margin: 30px 0; text-align: center;">
    <svg viewBox="0 0 560 330" style="max-width: 560px; width: 100%;">
      <!-- Axes -->
      <line x1="65" y1="270" x2="420" y2="270" stroke="#333" stroke-width="2"/>
      <line x1="65" y1="270" x2="65" y2="25" stroke="#333" stroke-width="2"/>

      <!-- Y-axis label -->
      <text x="25" y="148" text-anchor="middle" font-size="13" fill="#333" transform="rotate(-90, 25, 148)">Outcome</text>

      <!-- Pre/Post labels -->
      <text x="158" y="290" text-anchor="middle" font-size="11" fill="#555">Pre-treatment</text>
      <text x="335" y="290" text-anchor="middle" font-size="11" fill="#555">Post-treatment</text>

      <!-- Treatment vertical line -->
      <line x1="250" y1="25" x2="250" y2="270" stroke="#555" stroke-width="1.5" stroke-dasharray="6,4"/>
      <text x="250" y="18" text-anchor="middle" font-size="10" fill="#555" font-style="italic">Treatment</text>

      <!-- Control group (teal, solid throughout) -->
      <line x1="85" y1="240" x2="415" y2="150" stroke="#009688" stroke-width="2.8"/>

      <!-- Treatment group pre-treatment (purple, solid, parallel to control) -->
      <line x1="85" y1="195" x2="250" y2="150" stroke="#7B1FA2" stroke-width="2.8"/>

      <!-- Counterfactual (orange, dashed - continues pre-treatment trend) -->
      <line x1="250" y1="150" x2="415" y2="105" stroke="#E65100" stroke-width="2.8" stroke-dasharray="10,6"/>

      <!-- Treatment group post-treatment actual (purple, solid - diverges upward) -->
      <line x1="250" y1="150" x2="415" y2="50" stroke="#7B1FA2" stroke-width="2.8"/>

      <!-- Dots at treatment time -->
      <circle cx="250" cy="195" r="4" fill="#009688"/>
      <circle cx="250" cy="150" r="4" fill="#7B1FA2"/>

      <!-- Treatment Effect bracket -->
      <line x1="425" y1="52" x2="425" y2="103" stroke="#333" stroke-width="1.5"/>
      <line x1="420" y1="52" x2="430" y2="52" stroke="#333" stroke-width="1.5"/>
      <line x1="420" y1="103" x2="430" y2="103" stroke="#333" stroke-width="1.5"/>
      <text x="438" y="72" font-size="10" fill="#333" font-weight="bold">Treatment</text>
      <text x="438" y="84" font-size="10" fill="#333" font-weight="bold">effect</text>

      <!-- Constant difference bracket (parallel trends) -->
      <line x1="425" y1="109" x2="425" y2="148" stroke="#555" stroke-width="1.2" stroke-dasharray="3,2"/>
      <line x1="420" y1="109" x2="430" y2="109" stroke="#555" stroke-width="1.2"/>
      <line x1="420" y1="148" x2="430" y2="148" stroke="#555" stroke-width="1.2"/>
      <text x="438" y="125" font-size="9" fill="#555">Parallel</text>
      <text x="438" y="136" font-size="9" fill="#555">trends</text>

      <!-- Legend -->
      <line x1="70" y1="315" x2="100" y2="315" stroke="#009688" stroke-width="3"/>
      <text x="105" y="319" font-size="10" fill="#333">Control group</text>
      <line x1="195" y1="315" x2="225" y2="315" stroke="#7B1FA2" stroke-width="3"/>
      <text x="230" y="319" font-size="10" fill="#333">Treatment group</text>
      <line x1="345" y1="315" x2="375" y2="315" stroke="#E65100" stroke-width="3" stroke-dasharray="10,6"/>
      <text x="380" y="319" font-size="10" fill="#333">Counterfactual</text>
    </svg>
    <p style="font-size: 0.85rem; color: var(--muted); margin-top: 8px;">The treatment effect is the gap between the actual outcome and the counterfactual (what would have happened without treatment). Parallel trends means the gap between the two groups would have stayed constant absent treatment.</p>
  </div>

  <h3>The Parallel Trends Assumption</h3>

  {% capture kp_content %}
    <p>DiD requires that absent treatment, the treatment group would have followed the same trend as the control group. This is <strong>untestable</strong> because we can't observe the counterfactual.</p>
  {% endcapture %}
  {% include "key-principle.liquid", title: "Critical Assumption", content: kp_content %}

  <p>In the minimum wage example, we're assuming that if treated states had <em>not</em> raised their minimum wage, their employment would have evolved the same way as the control states' employment.</p>

  <p><strong>Pre-trends validation:</strong> If the two groups were following parallel trajectories <em>before</em> treatment, that's reassuring. We can check whether employment (or other outcomes) moved together in the pre-treatment period. If pre-trends are parallel and the two groups seem like they'd be following similar trajectories, we can typically say it's a good control group and design.</p>

  <p><strong>If pre-trends aren't parallel:</strong> This suggests the groups were too different to begin with. If treated states were already on a different employment trajectory before the policy change, any post-policy difference might just reflect pre-existing differences, not the effect of the minimum wage.</p>

  <p><strong>Balance on observables:</strong> It can also be useful to check whether the treatment and control groups are similar on observable characteristics before treatment. If they look similar on things we can measure (demographics, industry mix, prior employment trends), it's more plausible they'd follow similar trajectories.</p>

  {% capture callout_content %}
    <strong>The fundamental limitation:</strong> We can never <em>prove</em> that the groups would not have diverged absent the treatment. But if they had been following parallel trajectories for many time periods before treatment, a reasonable person could assume they would have continued on parallel trajectories afterward.
  {% endcapture %}
  {% include "callout.liquid", type: "info", content: callout_content %}

  <h4>What We Can Check</h4>

  <p>While we can't prove parallel trends, we can check if trends were parallel <em>before</em> treatment:</p>

  {% capture sc %}* Check pre-trends with an event study
gen time_to_treat = year - treatment_year
forvalues k = -5/-1 {
    gen pre`=abs(`k')' = (time_to_treat == `k') * treated_group
}
forvalues k = 0/5 {
    gen post`k' = (time_to_treat == `k') * treated_group
}

reghdfe wages pre5-pre2 post0-post5, absorb(school year) cluster(school)

* If pre-period coefficients are near zero, parallel trends is plausible{% endcapture %}
  {% capture rc %}# Check pre-trends with an event study
pacman::p_load(fixest, ggfixest)

# IMPORTANT: Never-treated units don't have a "time to treatment"
# Set them to -1000 and exclude with ref = c(-1, -1000)
df <- df %>%
  mutate(
    time_to_treat = ifelse(is.na(treatment_year), -1000, year - treatment_year),
    ever_treated = !is.na(treatment_year)
  )

# Event study regression
# ref = c(-1, -1000) excludes both the reference period and never-treated
es <- feols(wages ~ i(time_to_treat, ever_treated, ref = c(-1, -1000)) |
            school + year, data = df, cluster = ~school)

# Plot coefficients
p <- ggiplot(es)

# If pre-period coefficients are near zero, parallel trends is plausible{% endcapture %}
  {% capture pc %}# Check pre-trends with an event study
import pandas as pd
import linearmodels as lm

df['time_to_treat'] = df['year'] - df['treatment_year']

# Create event study dummies
for k in range(-5, 6):
    if k != -1:  # Reference period
        df[f'period_{k}'] = ((df['time_to_treat'] == k) * df['treated_group']).astype(int)

# Event study with fixed effects
model = lm.PanelOLS.from_formula(
    'wages ~ period_m5 + period_m4 + period_m3 + period_m2 + '
    'period_0 + period_1 + period_2 + period_3 + period_4 + period_5 + '
    'EntityEffects + TimeEffects',
    data=df.set_index(['school', 'year'])
).fit(cov_type='clustered', cluster_entity=True)

# If pre-period coefficients are near zero, parallel trends is plausible{% endcapture %}
  {% include "code-block.liquid", stata: sc, r: rc, python: pc %}

  <h3>Other Key Assumptions</h3>

  <p><strong>No differential contemporaneous shocks:</strong> DiD assumes there's no other shock that hits only the treated group at the same time as treatment. If treated states also experienced a major factory closure at the same time as the minimum wage increase, we couldn't separate the effect of the minimum wage from the effect of the factory closure.</p>

  <p><strong>Treatment is often a "package":</strong> A minimum wage increase may come bundled with other labor reforms. DiD estimates the combined effect of the whole package—you can't separately identify the effect of one component versus another.</p>
</section>

<section id="rd" class="tutorial-section">
  <h2>Regression Discontinuity (RD)</h2>

  <p>RD exploits sharp cutoffs in treatment assignment. If treatment jumps discontinuously at a threshold, units just above and below the cutoff are essentially randomly assigned.</p>

  <h3>SAT Score Example</h3>

  <p>Suppose MIT admits students who score above 1500 on the SAT. Consider two students:</p>

  <ul>
    <li>Alice: SAT = 1502 (admitted to MIT)</li>
    <li>Bob: SAT = 1498 (not admitted to MIT)</li>
  </ul>

  <p>Alice and Bob are nearly identical—separated by a trivial difference in test performance. If we compare their wages, we're getting close to a true causal effect.</p>

  <!-- RD Visual -->
  <div style="margin: 30px 0; text-align: center;">
    <svg viewBox="0 0 450 280" style="max-width: 450px; width: 100%;">
      <!-- Axes -->
      <line x1="60" y1="220" x2="400" y2="220" stroke="#333" stroke-width="2"/>
      <line x1="60" y1="220" x2="60" y2="40" stroke="#333" stroke-width="2"/>

      <!-- Y-axis label -->
      <text x="25" y="130" text-anchor="middle" font-size="12" fill="#333" transform="rotate(-90, 25, 130)">Wages ($000s)</text>

      <!-- X-axis label -->
      <text x="230" y="260" text-anchor="middle" font-size="12" fill="#333">SAT Score</text>

      <!-- X-axis ticks -->
      <text x="100" y="240" text-anchor="middle" font-size="10" fill="#333">1400</text>
      <text x="180" y="240" text-anchor="middle" font-size="10" fill="#333">1450</text>
      <text x="260" y="240" text-anchor="middle" font-size="10" fill="#333">1500</text>
      <text x="340" y="240" text-anchor="middle" font-size="10" fill="#333">1550</text>

      <!-- Cutoff line -->
      <line x1="260" y1="40" x2="260" y2="220" stroke="#750014" stroke-width="2" stroke-dasharray="5,5"/>
      <text x="260" y="30" text-anchor="middle" font-size="10" fill="#750014">Cutoff</text>

      <!-- Data points (below cutoff) -->
      <circle cx="90" cy="180" r="4" fill="#2196f3" opacity="0.6"/>
      <circle cx="110" cy="175" r="4" fill="#2196f3" opacity="0.6"/>
      <circle cx="130" cy="165" r="4" fill="#2196f3" opacity="0.6"/>
      <circle cx="150" cy="158" r="4" fill="#2196f3" opacity="0.6"/>
      <circle cx="170" cy="155" r="4" fill="#2196f3" opacity="0.6"/>
      <circle cx="190" cy="148" r="4" fill="#2196f3" opacity="0.6"/>
      <circle cx="210" cy="142" r="4" fill="#2196f3" opacity="0.6"/>
      <circle cx="230" cy="138" r="4" fill="#2196f3" opacity="0.6"/>
      <circle cx="250" cy="132" r="4" fill="#2196f3" opacity="0.6"/>

      <!-- Data points (above cutoff) -->
      <circle cx="270" cy="95" r="4" fill="#27ae60" opacity="0.6"/>
      <circle cx="290" cy="90" r="4" fill="#27ae60" opacity="0.6"/>
      <circle cx="310" cy="85" r="4" fill="#27ae60" opacity="0.6"/>
      <circle cx="330" cy="82" r="4" fill="#27ae60" opacity="0.6"/>
      <circle cx="350" cy="78" r="4" fill="#27ae60" opacity="0.6"/>
      <circle cx="370" cy="75" r="4" fill="#27ae60" opacity="0.6"/>

      <!-- Regression lines -->
      <line x1="80" y1="185" x2="255" y2="128" stroke="#2196f3" stroke-width="2"/>
      <line x1="265" y1="98" x2="380" y2="72" stroke="#27ae60" stroke-width="2"/>

      <!-- RD estimate bracket -->
      <line x1="255" y1="128" x2="255" y2="98" stroke="#750014" stroke-width="2"/>
      <text x="245" y="115" text-anchor="end" font-size="11" fill="#750014" font-weight="bold">RD effect</text>

      <!-- Labels -->
      <text x="150" y="200" text-anchor="middle" font-size="10" fill="#2196f3">Not admitted</text>
      <text x="330" y="60" text-anchor="middle" font-size="10" fill="#27ae60">Admitted</text>
    </svg>
  </div>

  <h3>RD Assumptions</h3>

  <div style="display: grid; gap: 16px; margin: 20px 0;">
    <div style="background: #e8f5e9; border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
      <h4 style="margin-top: 0; color: #27ae60;">Continuity</h4>
      <p style="margin-bottom: 0;">All other factors that affect wages vary <em>smoothly</em> across the cutoff. There's no other reason for a jump at exactly 1500.</p>
    </div>
    <div style="background: #e8f5e9; border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
      <h4 style="margin-top: 0; color: #27ae60;">No Manipulation</h4>
      <p style="margin-bottom: 0;">Students can't precisely control their score to land just above the cutoff. If they could, those just above would be systematically different from those just below.</p>
    </div>
  </div>

  <h3>Testing the Assumptions</h3>

  {% capture sc %}* Check for manipulation: McCrary density test
rddensity sat_score, c(1500) plot

* Check for jumps in covariates (should be smooth)
rdrobust family_income sat_score, c(1500)
rdrobust parental_education sat_score, c(1500)

* Main RD estimate
rdrobust wages sat_score, c(1500){% endcapture %}
  {% capture rc %}# Check for manipulation: density test
pacman::p_load(rddensity)
density_test <- rddensity(X = df$sat_score, c = 1500)
summary(density_test)
rdplotdensity(density_test, X = df$sat_score)

# Check for jumps in covariates (should be smooth)
pacman::p_load(rdrobust)
rdrobust(y = df$family_income, x = df$sat_score, c = 1500)

# Main RD estimate
rdrobust(y = df$wages, x = df$sat_score, c = 1500){% endcapture %}
  {% capture pc %}# RD analysis in Python
from rdrobust import rdrobust, rdbwselect
from rddensity import rddensity

# Check for manipulation: density test
density_test = rddensity(X=df['sat_score'], c=1500)
print(density_test)

# Check for jumps in covariates (should be smooth)
rd_covariate = rdrobust(y=df['family_income'], x=df['sat_score'], c=1500)
print(rd_covariate)

# Main RD estimate
rd_result = rdrobust(y=df['wages'], x=df['sat_score'], c=1500)
print(rd_result){% endcapture %}
  {% include "code-block.liquid", stata: sc, r: rc, python: pc %}

  {% capture callout_content %}
    <strong>Limitation:</strong> RD estimates a <em>local</em> effect—the effect for students right at the cutoff. This might not generalize to students with much higher or lower scores.
  {% endcapture %}
  {% include "callout.liquid", type: "warning", content: callout_content %}
</section>

<section id="iv" class="tutorial-section">
  <h2>Instrumental Variables (IV)</h2>

  <p>IV uses an external source of variation that affects treatment but has no direct effect on the outcome. This "instrument" isolates the causal effect.</p>

  <h3>MIT Parent as an Instrument?</h3>

  <p>Consider using "having a parent who went to MIT" as an instrument for attending MIT yourself.</p>

  {% capture kp_content %}
    <ol style="margin-bottom: 0;">
      <li><strong>Relevance:</strong> The instrument must affect treatment (testable)</li>
      <li><strong>Exclusion:</strong> The instrument must only affect the outcome <em>through</em> treatment (not testable)</li>
      <li><strong>Independence:</strong> The instrument must be as-if randomly assigned</li>
    </ol>
  {% endcapture %}
  {% include "key-principle.liquid", title: "Requirements for a Valid Instrument", content: kp_content %}

  <h3>Checking Relevance (First Stage)</h3>

  <p>Does having an MIT parent increase the probability of attending MIT? Almost certainly yes:</p>

  {% capture sc %}* First stage: parent_mit → attended_mit
reg attended_mit parent_mit controls
* Look for F-statistic > 10 (rule of thumb){% endcapture %}
  {% capture rc %}# First stage: parent_mit → attended_mit
first_stage <- lm(attended_mit ~ parent_mit + controls, data = df)
summary(first_stage)
# Look for F-statistic > 10 (rule of thumb){% endcapture %}
  {% capture pc %}# First stage: parent_mit → attended_mit
import statsmodels.formula.api as smf
first_stage = smf.ols('attended_mit ~ parent_mit + controls', data=df).fit()
print(first_stage.summary())
# Look for F-statistic > 10 (rule of thumb){% endcapture %}
  {% include "code-block.liquid", stata: sc, r: rc, python: pc %}

  <p>Legacy admissions are common at elite schools, so this first stage would likely be strong.</p>

  <h3>The Exclusion Restriction Problem</h3>

  {% capture cm_content %}
    <p>Having an MIT parent affects your wages through many channels besides your own MIT attendance:</p>
    <ul>
      <li><strong>Genetics:</strong> MIT parents may pass on high-ability genes</li>
      <li><strong>Environment:</strong> Growing up with MIT parents means more educational resources, intellectual stimulation</li>
      <li><strong>Networks:</strong> MIT parents have connections that help their children's careers regardless of college</li>
      <li><strong>Wealth:</strong> MIT parents tend to be wealthy, providing financial advantages</li>
    </ul>
    <p>The instrument affects wages <em>directly</em>, not just through MIT attendance. The exclusion restriction is violated.</p>
  {% endcapture %}
  {% include "common-mistake.liquid", title: "Why This Instrument FAILS", content: cm_content %}

  <!-- IV Diagram -->
  <div style="margin: 30px 0; text-align: center;">
    <svg viewBox="0 0 500 180" style="max-width: 500px; width: 100%;">
      <!-- MIT Parent box -->
      <rect x="20" y="60" width="100" height="40" fill="#f8f9fa" stroke="#750014" stroke-width="2" rx="4"/>
      <text x="70" y="85" text-anchor="middle" font-size="11" fill="#333">MIT Parent</text>

      <!-- Attended MIT box -->
      <rect x="200" y="60" width="100" height="40" fill="#e8f5e9" stroke="#27ae60" stroke-width="2" rx="4"/>
      <text x="250" y="85" text-anchor="middle" font-size="11" fill="#333">Attended MIT</text>

      <!-- Wages box -->
      <rect x="380" y="60" width="100" height="40" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="4"/>
      <text x="430" y="85" text-anchor="middle" font-size="11" fill="#333">Wages</text>

      <!-- Arrow: Parent → MIT (valid first stage) -->
      <line x1="120" y1="80" x2="195" y2="80" stroke="#27ae60" stroke-width="2" marker-end="url(#arrowhead-green2)"/>
      <text x="157" y="72" text-anchor="middle" font-size="9" fill="#27ae60">Relevant ✓</text>

      <!-- Arrow: MIT → Wages (causal effect) -->
      <line x1="300" y1="80" x2="375" y2="80" stroke="#27ae60" stroke-width="2" marker-end="url(#arrowhead-green2)"/>

      <!-- Arrow: Parent → Wages (VIOLATION) -->
      <path d="M 70 100 Q 70 150 250 150 Q 430 150 430 105" stroke="#c0392b" stroke-width="2" fill="none" marker-end="url(#arrowhead-red)"/>
      <text x="250" y="170" text-anchor="middle" font-size="9" fill="#c0392b">Exclusion violated! ✗</text>
      <text x="250" y="142" text-anchor="middle" font-size="8" fill="#c0392b">(Genetics, wealth, networks...)</text>

      <defs>
        <marker id="arrowhead-green2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#27ae60"/>
        </marker>
        <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#c0392b"/>
        </marker>
      </defs>
    </svg>
  </div>

  <h3>What Would Make a Good Instrument?</h3>

  <p>A valid instrument needs to be:</p>

  <ol>
    <li><strong>Correlated with MIT attendance</strong></li>
    <li><strong>Plausibly random</strong> (not chosen based on ability or ambition)</li>
    <li><strong>Only affecting wages through MIT</strong></li>
  </ol>

  <p>Some possibilities that economists have tried for college quality questions (though most are debatable):</p>

  <ul>
    <li><strong>Geographic proximity:</strong> Distance to college (Card, 1995)—but does distance really have no direct effect on outcomes?</li>
    <li><strong>Lottery-based admissions:</strong> Some programs use lotteries among qualified applicants—rare but credible when available</li>
    <li><strong>Policy changes:</strong> Changes in financial aid that affect some students but not others</li>
  </ul>

  <p style="font-size: 0.9em; color: var(--muted);"><strong>Caveat:</strong> Good instruments are hard to find. Most proposed instruments have plausible exclusion restriction violations. This is why IV is less common in student projects than DiD.</p>

  {% capture callout_content %}
    <strong>Key insight:</strong> A good instrument is rare because you need something that affects college choice but has no other connection to labor market success. Most things that affect whether you go to MIT also affect your wages directly.
  {% endcapture %}
  {% include "callout.liquid", type: "success", content: callout_content %}
</section>

<section id="summary" class="tutorial-section">
  <h2>Summary: Choosing a Design</h2>

  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem;">
      <thead>
        <tr style="background: var(--bg-subtle);">
          <th style="padding: 12px; text-align: left; border: 1px solid var(--border);">Method</th>
          <th style="padding: 12px; text-align: left; border: 1px solid var(--border);">Key Assumption</th>
          <th style="padding: 12px; text-align: left; border: 1px solid var(--border);">Testable?</th>
          <th style="padding: 12px; text-align: left; border: 1px solid var(--border);">MIT Example</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 12px; border: 1px solid var(--border);"><strong>RCT</strong></td>
          <td style="padding: 12px; border: 1px solid var(--border);">None (randomization)</td>
          <td style="padding: 12px; border: 1px solid var(--border);">N/A</td>
          <td style="padding: 12px; border: 1px solid var(--border);">Not feasible</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid var(--border);"><strong>DiD</strong></td>
          <td style="padding: 12px; border: 1px solid var(--border);">Parallel trends</td>
          <td style="padding: 12px; border: 1px solid var(--border);">Partially (pre-trends)</td>
          <td style="padding: 12px; border: 1px solid var(--border);">Scholarship policy change</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid var(--border);"><strong>RD</strong></td>
          <td style="padding: 12px; border: 1px solid var(--border);">No manipulation, continuity</td>
          <td style="padding: 12px; border: 1px solid var(--border);">Partially (density, covariates)</td>
          <td style="padding: 12px; border: 1px solid var(--border);">SAT cutoff for admission</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid var(--border);"><strong>IV</strong></td>
          <td style="padding: 12px; border: 1px solid var(--border);">Exclusion restriction</td>
          <td style="padding: 12px; border: 1px solid var(--border);">No (only relevance)</td>
          <td style="padding: 12px; border: 1px solid var(--border);">MIT parent fails; need better instrument</td>
        </tr>
      </tbody>
    </table>
  </div>

  {% capture kp_content %}
    <p>There is no perfect method. Every causal inference strategy requires assumptions that cannot be fully tested. The goal is to find <strong>plausible</strong> sources of variation and be transparent about what could go wrong. The best research combines multiple approaches and tests robustness.</p>
  {% endcapture %}
  {% include "key-principle.liquid", title: "The Bottom Line", content: kp_content %}
</section>
