---
layout: layouts/tutorial.html
title: Regression | Intro to Data Analysis for Economics
current_page: regression
---
<h1>Regression</h1>
<p class="subtitle">OLS, panel data, IV, DiD, and event studies</p>

<!-- Growth Mindset Message -->
<div class="callout-success">
  <strong>Regression is just a function</strong>
  <p style="margin: 8px 0 0;">
    Every regression command follows the same pattern: <code>reg Y X, options</code>. Fixed effects? Add <code>absorb()</code>. Clustered SEs? Add <code>cluster()</code>. IV? Wrap the endogenous variable. Once you understand the basic syntax, everything else is just variations on a theme.
  </p>
</div>

<section id="ols" class="tutorial-section">
  <h2>OLS Basics</h2>

  <p>Ordinary Least Squares (OLS) finds the line that minimizes the sum of squared differences between observed values and predicted values. It gives you the "best-fitting" linear relationship between your outcome variable Y and your predictors X. The slope coefficient tells you: holding everything else constant, how much does Y change when X increases by one unit?</p>

  <h3>Simple Linear Regression</h3>

  <!-- Anatomy of a regression -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The basic regression equation:</div>
    <div style="font-size: 1.1em; text-align: center; padding: 10px;">
      <span style="color: #1565c0;">income</span> =
      Œ≤‚ÇÄ + Œ≤‚ÇÅ<span style="color: #2e7d32;">education</span> +
      Œ≤‚ÇÇ<span style="color: #2e7d32;">age</span> + Œµ
    </div>
    <div style="display: flex; gap: 20px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #1565c0;">‚ñ†</span> Y (what we're predicting)</span>
      <span><span style="color: #2e7d32;">‚ñ†</span> X (predictors)</span>
    </div>
  </div>
  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Simple regression
reg income education

* Multiple regression
reg income education age female

* With categorical variables (factor notation)
reg income education i.region i.year

* Interactions
reg income education##female    // Full interaction
reg income c.education#c.age    // Continuous interaction</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest)

# Simple regression
model <- feols(income ~ education, data = data)
summary(model)

# Multiple regression
model <- feols(income ~ education + age + female, data = data)

# With categorical variables
model <- feols(income ~ education + factor(region) + factor(year),
               data = data)

# Interactions
model <- feols(income ~ education * female, data = data)
model <- feols(income ~ education:age, data = data)</code></pre>
    <pre class="code-content python"><code class="language-python">import statsmodels.formula.api as smf
import pandas as pd

# Simple regression
model = smf.ols('income ~ education', data=data).fit()
print(model.summary())

# Multiple regression
model = smf.ols('income ~ education + age + female', data=data).fit()

# With categorical variables
model = smf.ols('income ~ education + C(region) + C(year)', data=data).fit()

# Interactions
model = smf.ols('income ~ education * female', data=data).fit()
model = smf.ols('income ~ education:age', data=data).fit()</code></pre>
  </div>

  <h3>Interpreting Coefficients</h3>
  <div class="key-principle">
    <h4>Coefficient Interpretation</h4>
    <ul>
      <li><strong>Continuous X:</strong> A one-unit increase in X is associated with a beta-unit change in Y, holding other variables constant.</li>
      <li><strong>Binary X:</strong> The difference in Y between X=1 and X=0, holding other variables constant.</li>
      <li><strong>Log Y:</strong> A one-unit increase in X is associated with a (beta*100)% change in Y.</li>
      <li><strong>Log X:</strong> A 1% increase in X is associated with a (beta/100)-unit change in Y.</li>
      <li><strong>Log-Log:</strong> A 1% increase in X is associated with a beta% change in Y (elasticity).</li>
    </ul>
  </div>

  <h3>Post-Estimation</h3>
  <p>After running a regression, you often want to do more than just look at coefficients. <strong>Predicted values</strong> show what your model expects for each observation‚Äîuseful for identifying outliers or visualizing fit. <strong>Residuals</strong> are the difference between actual and predicted values‚Äîpatterns in residuals can reveal model problems. <strong>Hypothesis tests</strong> let you ask specific questions: Is this coefficient different from zero? Are two coefficients equal? What's the combined effect of multiple variables?</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">reg income education age female

* Predicted values
predict yhat

* Residuals
predict resid, residuals

* Test coefficient equals zero
test education = 0

* Test multiple coefficients
test education age

* Linear combination of coefficients
lincom education + 2*age</code></pre>
    <pre class="code-content r"><code class="language-r">model <- lm(income ~ education + age + female, data = data)

# Predicted values
data$yhat <- predict(model)

# Residuals
data$resid <- residuals(model)

# Test coefficient equals zero (from summary)
summary(model)$coefficients

# F-test for multiple coefficients
pacman::p_load(car)
linearHypothesis(model, c("education = 0", "age = 0"))

# Linear combination
pacman::p_load(multcomp)
glht(model, linfct = c("education + 2*age = 0"))</code></pre>
    <pre class="code-content python"><code class="language-python">import statsmodels.formula.api as smf

model = smf.ols('income ~ education + age + female', data=data).fit()

# Predicted values
data['yhat'] = model.predict()

# Residuals
data['resid'] = model.resid

# Test coefficient equals zero (from summary)
print(model.summary())

# F-test for multiple coefficients (joint hypothesis)
print(model.f_test("(education = 0), (age = 0)"))

# Linear combination
print(model.t_test("education + 2*age = 0"))</code></pre>
  </div>
</section>

<section id="standard-errors" class="tutorial-section">
  <h2>Standard Errors</h2>

  <p>Standard errors measure how precisely you've estimated each coefficient. A coefficient of 10 with a standard error of 2 is very different from a coefficient of 10 with a standard error of 50‚Äîthe first is precisely estimated, the second is essentially noise. Standard errors determine your confidence intervals and p-values, so getting them right is crucial for inference.</p>

  <p>The challenge is that standard OLS assumes errors are independent across observations. In real data, this is often violated: observations within the same state are correlated, the same person observed over time is correlated, etc. When errors are correlated, standard OLS standard errors are too small, leading to false confidence in your results.</p>

  <div class="key-principle">
    <h4>Always Cluster When in Doubt</h4>
    <p>If observations within groups (states, firms, individuals over time) are correlated, standard OLS standard errors are too small. Cluster at the level of treatment variation or the highest level of aggregation that makes sense.</p>
  </div>

  <h3>Types of Standard Errors</h3>
  <p>Here are the main options for computing standard errors, from simplest to most robust:</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Heteroskedasticity-robust (HC1)
reg income education, robust

* Clustered by state
reg income education, cluster(state)

* Two-way clustering (requires reghdfe)
reghdfe income education, noabsorb cluster(state year)

* With reghdfe (recommended for fixed effects)
reghdfe income education, absorb(state) cluster(state)</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest)

# Heteroskedasticity-robust
model <- feols(income ~ education, data = data, vcov = "hetero")

# Clustered by state
model <- feols(income ~ education, data = data, vcov = ~state)

# Two-way clustering
model <- feols(income ~ education, data = data, vcov = ~state + year)

# With fixed effects
model <- feols(income ~ education | state, data = data, vcov = ~state)</code></pre>
    <pre class="code-content python"><code class="language-python">import statsmodels.formula.api as smf

# Heteroskedasticity-robust (HC1)
model = smf.ols('income ~ education', data=data).fit(cov_type='HC1')

# Clustered by state
model = smf.ols('income ~ education', data=data).fit(
    cov_type='cluster', cov_kwds={'groups': data['state']})

# For fixed effects with clustering, use linearmodels
from linearmodels.panel import PanelOLS
data = data.set_index(['state', 'year'])
model = PanelOLS.from_formula(
    'income ~ education + EntityEffects',
    data=data
).fit(cov_type='clustered', cluster_entity=True)</code></pre>
  </div>

  <div class="common-mistakes">
    <h4>Clustering Rules of Thumb</h4>
    <ul>
      <li>Cluster at the level of treatment assignment (e.g., if policy varies by state, cluster by state)</li>
      <li>With few clusters (<30), consider wild bootstrap or other small-sample corrections</li>
      <li>Never cluster at a finer level than treatment variation</li>
    </ul>
  </div>
</section>

<section id="panel-data" class="tutorial-section">
  <h2>Panel Data and Fixed Effects</h2>

  <h3>Fixed Effects Regression</h3>
  <p>Fixed effects control for all time-invariant characteristics of each unit (observed and unobserved).</p>

  <!-- Fixed Effects Equation -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The fixed effects estimating equation:</div>
    <div style="font-size: 1.1em; text-align: center; padding: 10px;">
      <span style="color: #1565c0;">Y<sub>it</sub></span> =
      Œ≤‚ÇÄ + Œ≤‚ÇÅ<span style="color: #2e7d32;">X<sub>it</sub></span> +
      <span style="color: #7b1fa2;">Œ±<sub>i</sub></span> + Œµ<sub>it</sub>
    </div>
    <div style="display: flex; gap: 20px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #1565c0;">‚ñ†</span> Y<sub>it</sub> = outcome for unit i in time t</span>
      <span><span style="color: #2e7d32;">‚ñ†</span> X<sub>it</sub> = time-varying predictors</span>
      <span><span style="color: #7b1fa2;">‚ñ†</span> Œ±<sub>i</sub> = unit fixed effect (absorbs all time-invariant factors)</span>
    </div>
  </div>

  <!-- Why fixed effects work -->
  <div class="callout-warning">
    <strong>ü§î Think about this:</strong> You want to know if minimum wage increases affect employment. But states with high minimum wages might differ from states with low minimum wages in many ways (cost of living, industry mix, politics). How do you separate the effect of minimum wage from these other differences?
    <details style="margin-top: 12px;">
      <summary style="cursor: pointer; color: var(--primary);">Click for answer</summary>
      <p style="margin: 8px 0 0;"><strong>State fixed effects!</strong> By including a dummy for each state, you're comparing each state to itself over time. California in 2020 is compared to California in 2015, not to Texas. This "differences out" all the permanent differences between states.</p>
    </details>
  </div>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Declare panel structure
xtset state year

* Entity fixed effects
xtreg income policy, fe

* Better: use reghdfe for speed and flexibility
* Install: ssc install reghdfe
reghdfe income policy, absorb(state)

* Two-way fixed effects (entity + time)
reghdfe income policy, absorb(state year)

* With clustered standard errors
reghdfe income policy, absorb(state year) cluster(state)</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest)

# Entity fixed effects
model <- feols(income ~ policy | state, data = data)

# Two-way fixed effects (entity + time)
model <- feols(income ~ policy | state + year, data = data)

# With clustered standard errors
model <- feols(income ~ policy | state + year,
               data = data, vcov = ~state)

# View results
summary(model)
etable(model)</code></pre>
    <pre class="code-content python"><code class="language-python">from linearmodels.panel import PanelOLS
import pandas as pd

# Set multi-index for panel data
data = data.set_index(['state', 'year'])

# Entity fixed effects
model = PanelOLS.from_formula(
    'income ~ policy + EntityEffects',
    data=data
).fit()

# Two-way fixed effects (entity + time)
model = PanelOLS.from_formula(
    'income ~ policy + EntityEffects + TimeEffects',
    data=data
).fit()

# With clustered standard errors
model = PanelOLS.from_formula(
    'income ~ policy + EntityEffects + TimeEffects',
    data=data
).fit(cov_type='clustered', cluster_entity=True)

print(model.summary)</code></pre>
  </div>

  <h3>What Do Fixed Effects Actually Do?</h3>

  <p><strong>Unit fixed effects</strong> control for all characteristics of a unit that don't change over time. To see why this matters, consider estimating the effect of education on wages.</p>

  <p>You might worry that race and sex affect both education and wages. So you add them as controls:</p>

  <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace; text-align: center;">
    wage<sub>it</sub> = Œ≤‚ÇÄ + Œ≤‚ÇÅ education<sub>it</sub> + Œ≤‚ÇÇ race<sub>i</sub> + Œ≤‚ÇÉ sex<sub>i</sub> + Œµ<sub>it</sub>
  </div>

  <p>But what about other time-invariant characteristics you can't measure? Family background, innate ability, childhood neighborhood, personality traits‚Äîall of these might affect both education and wages. You can't observe them, so you can't control for them.</p>

  <p><strong>Individual fixed effects solve this.</strong> By including a dummy for each person, you control for <em>everything</em> about that person that doesn't change over time‚Äîobserved or unobserved:</p>

  <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace; text-align: center;">
    wage<sub>it</sub> = Œ≤‚ÇÅ education<sub>it</sub> + <span style="color: var(--primary);">Œ±<sub>i</sub></span> + Œµ<sub>it</sub>
  </div>

  <p>The Œ±<sub>i</sub> absorbs race, sex, family background, innate ability, and every other time-invariant characteristic. You don't need to list them individually‚Äîthe fixed effect captures them all. The cost is you can no longer estimate the effect of time-invariant variables (Œ≤‚ÇÇ and Œ≤‚ÇÉ disappear), but you've eliminated a whole class of omitted variable bias.</p>

  <p><strong>Time fixed effects</strong> work the same way but for time periods. They control for anything that affects all units in a given period‚Äîrecessions, policy changes, seasonal patterns:</p>

  <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace; text-align: center;">
    wage<sub>it</sub> = Œ≤‚ÇÅ education<sub>it</sub> + <span style="color: var(--primary);">Œ±<sub>i</sub></span> + <span style="color: var(--secondary);">Œ≥<sub>t</sub></span> + Œµ<sub>it</sub>
  </div>

  <p>With both unit and time fixed effects (two-way fixed effects), your estimate of Œ≤‚ÇÅ comes purely from <em>within-unit changes over time</em>, after removing any time trends common to all units. This is the workhorse specification for causal inference with panel data.</p>

  <div class="callout-info">
    <h4>TWFE Powers DiD and Event Studies</h4>
    <p><strong>Difference-in-differences</strong> and <strong>event studies</strong>‚Äîthe most common designs in applied microeconomics‚Äîare almost always estimated using two-way fixed effects. The unit fixed effects control for permanent differences between treated and control groups. The time fixed effects control for common shocks that hit everyone. What's left is the treatment effect: how treated units changed <em>relative to</em> control units, <em>relative to</em> the time trend. When you see a DiD or event study paper, you're almost certainly looking at a TWFE regression.</p>
  </div>

  <div class="callout-warning">
    <h4>The Limitation</h4>
    <p>Fixed effects only control for time-<em>invariant</em> confounders. If something changes over time and affects both your treatment and outcome (a time-varying confounder), fixed effects won't help. You'd need to control for it directly or find a different identification strategy.</p>
  </div>

</section>

<section id="iv" class="tutorial-section">
  <h2>Instrumental Variables</h2>

  <p>Suppose you want to know: <strong>does more education cause higher wages?</strong> You run a regression of wages on years of schooling and find a positive coefficient. But does this mean education <em>causes</em> higher wages?</p>

  <p>The problem is that people who get more education might be different in ways that also affect their wages. Maybe they're smarter, more motivated, or from wealthier families. These traits affect both education <em>and</em> wages. So when you see that educated people earn more, you can't tell if it's because:</p>

  <ul>
    <li>Education actually makes people more productive (the causal effect you want), or</li>
    <li>Smart/motivated people both get more education <em>and</em> earn more (a confound)</li>
  </ul>

  <p>OLS mixes these together. Your coefficient captures both the true effect of education and the fact that "education" is partly a proxy for ability. This is called <strong>omitted variable bias</strong>‚Äîability affects both X and Y, but you can't measure it.</p>

  <h3>The IV Solution</h3>

  <p><strong>Instrumental variables</strong> solve this by finding something that affects education but has no direct effect on wages. This "instrument" creates variation in education that's unrelated to ability.</p>

  <p>A classic example: <strong>distance to the nearest college</strong>. People who grow up closer to a college tend to get more education (it's cheaper and easier to attend). But distance to a college doesn't directly make you earn more‚Äîit only affects wages through its effect on education.</p>

  <p>The logic: if we compare people who differ only in how close they grew up to a college, any wage difference must be due to their different education levels‚Äînot ability, since distance to college isn't correlated with ability.</p>

  <h3>Two-Stage Least Squares (2SLS)</h3>

  <p>In practice, we implement this in two stages:</p>

  <ol>
    <li><strong>First stage:</strong> Predict education using only the instrument (distance to college). This gives us "clean" variation in education that's driven by geography, not ability.</li>
    <li><strong>Second stage:</strong> Use these predicted education values to estimate the effect on wages. Since the predictions are based only on distance, they're uncorrelated with ability.</li>
  </ol>

  <!-- IV Equations -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The two-stage least squares estimating equations:</div>
    <div style="margin-bottom: 16px;">
      <div style="color: #666; font-size: 0.85em; margin-bottom: 4px;">First stage (predict endogenous variable):</div>
      <div style="font-size: 1.1em; text-align: center; padding: 8px; background: #fff; border-radius: 4px;">
        <span style="color: #e65100;">X<sub>i</sub></span> =
        œÄ‚ÇÄ + œÄ‚ÇÅ<span style="color: #1565c0;">Z<sub>i</sub></span> + ŒΩ<sub>i</sub>
      </div>
    </div>
    <div>
      <div style="color: #666; font-size: 0.85em; margin-bottom: 4px;">Second stage (use predicted values):</div>
      <div style="font-size: 1.1em; text-align: center; padding: 8px; background: #fff; border-radius: 4px;">
        <span style="color: #2e7d32;">Y<sub>i</sub></span> =
        Œ≤‚ÇÄ + Œ≤‚ÇÅ<span style="color: #e65100;">XÃÇ<sub>i</sub></span> + Œµ<sub>i</sub>
      </div>
    </div>
    <div style="display: flex; gap: 20px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #2e7d32;">‚ñ†</span> Y = outcome</span>
      <span><span style="color: #e65100;">‚ñ†</span> X = endogenous variable</span>
      <span><span style="color: #1565c0;">‚ñ†</span> Z = instrument</span>
    </div>
  </div>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* 2SLS: Y = outcome, X = endogenous, Z = instrument
* Syntax: ivregress 2sls Y controls (X = Z)

ivregress 2sls income age female (education = distance_to_college)

* First-stage F-statistic (check relevance)
estat firststage

* With robust standard errors
ivregress 2sls income age (education = distance), robust

* With fixed effects
ivreghdfe income age (education = distance), absorb(state) cluster(state)</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest)

# 2SLS with fixest
# Syntax: Y ~ controls | FE | endogenous ~ instrument
model <- feols(income ~ age + female | 0 | education ~ distance_to_college,
               data = data)
summary(model)

# Check first-stage F-statistic
fitstat(model, "ivf")

# With fixed effects
model <- feols(income ~ age | state | education ~ distance,
               data = data, vcov = ~state)</code></pre>
    <pre class="code-content python"><code class="language-python">from linearmodels.iv import IV2SLS
import pandas as pd

# 2SLS: Y = outcome, X = endogenous, Z = instrument
model = IV2SLS.from_formula(
    'income ~ 1 + age + female + [education ~ distance_to_college]',
    data=data
).fit()
print(model.summary)

# First-stage F-statistic
print(f"First-stage F: {model.first_stage.diagnostics['f.stat'].stat:.2f}")

# With robust standard errors
model = IV2SLS.from_formula(
    'income ~ 1 + age + [education ~ distance]',
    data=data
).fit(cov_type='robust')</code></pre>
  </div>

  <div class="key-principle">
    <h4>First-Stage F-Statistic</h4>
    <p>The F-statistic tests instrument relevance. Rule of thumb: F > 10 suggests the instrument is strong enough. Weak instruments (F < 10) lead to biased estimates and unreliable inference.</p>
  </div>

  <h3>Complete IV Example: Protest Size and Voting</h3>
  <p>Research question: Does protest size affect voting? Problem: larger protests might occur in places that would vote differently anyway. Solution: use weather (rain) as an instrument‚Äîrain reduces protest size but shouldn't directly affect voting.</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* First stage: Does rain affect protest size?
reg protest rain, robust
eststo first_stage

* 2SLS: Effect of protest on voting
ivregress 2sls vote (protest = rain), robust
eststo iv_model

* Reduced form: Direct effect of rain on voting
reg vote rain, robust
eststo reduced_form

* Export results
esttab first_stage iv_model reduced_form ///
    using "iv_results.tex", replace ///
    b(3) se(3) star(* 0.10 ** 0.05 *** 0.01) ///
    stats(N r2 F, fmt(%9.0fc %9.3f %9.2f))</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest, modelsummary)

# First stage: Does rain affect protest size?
first_stage <- feols(protest ~ rain, data = data, vcov = "hetero")

# 2SLS: Effect of protest on voting
iv_model <- feols(vote ~ 1 | 0 | protest ~ rain, data = data, vcov = "hetero")

# Reduced form: Direct effect of rain on voting
reduced_form <- feols(vote ~ rain, data = data, vcov = "hetero")

# Export results
modelsummary(
  list("First Stage" = first_stage,
       "2SLS" = iv_model,
       "Reduced Form" = reduced_form),
  stars = c('*' = 0.10, '**' = 0.05, '***' = 0.01),
  output = "iv_results.tex"
)</code></pre>
    <pre class="code-content python"><code class="language-python">import statsmodels.formula.api as smf
from linearmodels.iv import IV2SLS
from stargazer.stargazer import Stargazer

# First stage: Does rain affect protest size?
first_stage = smf.ols('protest ~ rain', data=data).fit(cov_type='HC1')

# 2SLS: Effect of protest on voting
iv_model = IV2SLS.from_formula(
    'vote ~ 1 + [protest ~ rain]', data=data
).fit(cov_type='robust')

# Reduced form: Direct effect of rain on voting
reduced_form = smf.ols('vote ~ rain', data=data).fit(cov_type='HC1')

# Export results
stargazer = Stargazer([first_stage, reduced_form])
stargazer.render_latex()  # or .render_html()</code></pre>
  </div>

  <h3>Common IV Pitfalls</h3>
  <div class="common-mistakes">
    <h4>Watch Out For</h4>
    <ul>
      <li><strong>Weak instruments:</strong> F < 10 means your IV estimates are badly biased toward OLS</li>
      <li><strong>Invalid exclusion:</strong> If the instrument affects Y directly, your estimate is biased</li>
      <li><strong>LATE vs ATE:</strong> IV estimates effects only for "compliers" - this may not generalize</li>
    </ul>
  </div>
</section>

<section id="did" class="tutorial-section">
  <h2>Difference-in-Differences</h2>

  <p>Difference-in-differences compares changes over time between a treated group and a control group. The key assumption is that both groups would have followed <strong>parallel trends</strong> in the absence of treatment.</p>

  <!-- DiD/TWFE Equation -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The two-way fixed effects (TWFE) estimating equation:</div>
    <div style="font-size: 1.1em; text-align: center; padding: 10px;">
      <span style="color: #1565c0;">Y<sub>it</sub></span> =
      Œ≤‚ÇÄ + <span style="color: #c62828;">Œ≤‚ÇÅ</span>(<span style="color: #2e7d32;">Treat<sub>i</sub></span> √ó <span style="color: #2e7d32;">Post<sub>t</sub></span>) +
      <span style="color: #7b1fa2;">Œ±<sub>i</sub></span> + <span style="color: #00695c;">Œ≥<sub>t</sub></span> + Œµ<sub>it</sub>
    </div>
    <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #1565c0;">‚ñ†</span> Y<sub>it</sub> = outcome</span>
      <span><span style="color: #2e7d32;">‚ñ†</span> Treat √ó Post = 1 if treated and after treatment</span>
      <span><span style="color: #7b1fa2;">‚ñ†</span> Œ±<sub>i</sub> = unit FE</span>
      <span><span style="color: #00695c;">‚ñ†</span> Œ≥<sub>t</sub> = time FE</span>
    </div>
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ccc; text-align: center; font-size: 0.9em;">
      <strong style="color: #c62828;">Œ≤‚ÇÅ is the DiD estimate</strong> ‚Äî the causal effect of treatment
    </div>
  </div>

  <!-- Visual explanation of DiD -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin: 20px 0;">
    <h4 style="margin-top: 0;">The DiD Logic in One Table</h4>
    <table style="width: 100%; border-collapse: collapse; text-align: center; margin: 12px 0;">
      <tr style="background: #e0e0e0;">
        <th style="padding: 12px; border: 1px solid #bdbdbd;"></th>
        <th style="padding: 12px; border: 1px solid #bdbdbd;">Before Treatment</th>
        <th style="padding: 12px; border: 1px solid #bdbdbd;">After Treatment</th>
        <th style="padding: 12px; border: 1px solid #bdbdbd;">Change</th>
      </tr>
      <tr>
        <td style="padding: 12px; border: 1px solid #e0e0e0; font-weight: bold;">Treated (got the policy)</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">A</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">B</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">B - A</td>
      </tr>
      <tr>
        <td style="padding: 12px; border: 1px solid #e0e0e0; font-weight: bold;">Control (no policy)</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">C</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">D</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">D - C</td>
      </tr>
      <tr style="background: #e3f2fd;">
        <td style="padding: 12px; border: 1px solid #bbdefb;" colspan="3"><strong>DiD Effect = (B - A) - (D - C)</strong></td>
        <td style="padding: 12px; border: 1px solid #bbdefb;"><strong>Causal effect</strong></td>
      </tr>
    </table>
    <p style="margin: 0; font-size: 0.9em;">
      <strong>Why this works:</strong> The change in the control group (D - C) tells us what would have happened to the treated group without treatment. Subtracting it removes secular trends.
    </p>
  </div>

  <h3>Real-World Example: No-Fault Divorce and Female Suicide</h3>
  <div class="key-principle">
    <h4>Research Question</h4>
    <p>Did the introduction of no-fault divorce laws affect female suicide rates? U.S. states adopted these laws at different times between 1969-1985, creating a natural experiment with staggered treatment timing.</p>
  </div>

  <p>The analysis requires setting up several key variables:</p>
  <ul>
    <li><strong>Treatment year</strong> ‚Äî When each state adopted no-fault divorce</li>
    <li><strong>Post indicator</strong> ‚Äî Whether the current year is after treatment for that state</li>
    <li><strong>Time to treatment</strong> ‚Äî Years before/after treatment (for event studies)</li>
  </ul>

  <h3>Basic 2x2 DiD</h3>
  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Generate treatment indicator
gen treated = (state == "CA")
gen post = (year >= 2015)
gen treat_post = treated * post

* Basic DiD regression
reg outcome treated post treat_post, cluster(state)

* The coefficient on treat_post is the DiD estimate

* Better: Two-way fixed effects
reghdfe outcome treat_post, absorb(state year) cluster(state)

* With controls (like the divorce study)
reghdfe asmrs treat_post pcinc asmrh cases, absorb(stfips year) cluster(stfips)</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest)

# Generate treatment indicator
data <- data %>%
  mutate(
    treated = state == "CA",
    post = year >= 2015,
    treat_post = treated * post
  )

# Basic DiD regression
model <- feols(outcome ~ treated + post + treat_post,
               data = data, vcov = ~state)

# Two-way fixed effects (preferred)
model <- feols(outcome ~ treat_post | state + year,
               data = data, vcov = ~state)

# The treat_post coefficient is the DiD estimate
summary(model)</code></pre>
    <pre class="code-content python"><code class="language-python">import pandas as pd
from linearmodels.panel import PanelOLS

# Generate treatment indicator
data['treated'] = (data['state'] == 'CA').astype(int)
data['post'] = (data['year'] >= 2015).astype(int)
data['treat_post'] = data['treated'] * data['post']

# Basic DiD regression
import statsmodels.formula.api as smf
model = smf.ols('outcome ~ treated + post + treat_post', data=data).fit(
    cov_type='cluster', cov_kwds={'groups': data['state']})

# Two-way fixed effects (preferred)
data_panel = data.set_index(['state', 'year'])
model = PanelOLS.from_formula(
    'outcome ~ treat_post + EntityEffects + TimeEffects',
    data=data_panel
).fit(cov_type='clustered', cluster_entity=True)

print(model.summary)</code></pre>
  </div>

  <h3>Testing Parallel Trends</h3>
  <p>The key assumption is that treated and control groups would have followed parallel trends absent treatment. Check pre-treatment trends:</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Create year dummies interacted with treatment
* (Omit the year before treatment as reference)
reghdfe outcome ib2014.year#treated, ///
    absorb(state year) cluster(state)

* Plot coefficients
coefplot, keep(*#*) vertical ///
    yline(0) xline(4.5, lpattern(dash)) ///
    title("Event Study: Pre-trends Check")</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest, ggfixest, dplyr)

# Create relative time variable
# Set never-treated units to -1000 (outside data range)
data <- data %>%
  mutate(
    rel_time = year - treatment_year,
    rel_time = if_else(is.na(rel_time), -1000, rel_time),
    treated = !is.na(treatment_year)
  )

# Event study regression
# ref = c(-1, -1000) excludes both t=-1 and never-treated (-1000)
model <- feols(
  outcome ~ i(rel_time, treated, ref = c(-1, -1000)) | state + year,
  data = data, vcov = ~state
)

# Plot with ggiplot (publication-ready)
p <- ggiplot(model) +
  labs(title = "Event Study: Pre-trends Check",
       x = "Years Relative to Treatment",
       y = "Coefficient Estimate") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal()</code></pre>
  </div>
</section>

<section id="event-studies" class="tutorial-section">
  <h2>Event Studies</h2>

  <p>Event studies show dynamic treatment effects over time, both before (to check parallel trends) and after treatment. They're essential for:</p>
  <p style="font-size: 0.9em; color: var(--muted);"><strong>R users:</strong> See the <a href="https://lrberge.github.io/fixest/articles/fixest_walkthrough.html" target="_blank">fixest walkthrough</a> for comprehensive documentation on event studies with <code>feols()</code>.</p>
  <ul>
    <li><strong>Testing parallel trends:</strong> Pre-treatment coefficients should be near zero</li>
    <li><strong>Understanding dynamics:</strong> Does the effect grow, shrink, or stay constant over time?</li>
    <li><strong>Detecting anticipation:</strong> Did units respond before official treatment?</li>
  </ul>

  <!-- Visual Examples of Event Study Patterns -->
  <div style="margin: 30px 0;">
    <h3>Reading Event Study Plots</h3>
    <p>Event study coefficients tell a story. Here's how to interpret common patterns:</p>

    <!-- Pattern 1: Parallel Trends -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin: 20px 0;">
      <h4 style="margin-top: 0; color: var(--primary);">1. Testing Parallel Trends</h4>
      <p>Pre-treatment coefficients (before t=0) should be statistically indistinguishable from zero. This suggests treated and control groups were on similar trajectories before treatment.</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px;">
        <!-- Good pre-trends -->
        <div style="text-align: center;">
          <div style="background: #e8f5e9; border: 2px solid #27ae60; border-radius: 8px; padding: 16px;">
            <svg viewBox="0 0 300 180" style="width: 100%; max-width: 280px;">
              <!-- Axes -->
              <line x1="40" y1="140" x2="280" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="20" x2="40" y2="140" stroke="#333" stroke-width="1.5"/>
              <!-- Zero line -->
              <line x1="40" y1="90" x2="280" y2="90" stroke="#c62828" stroke-width="1" stroke-dasharray="4"/>
              <!-- Treatment line -->
              <line x1="160" y1="20" x2="160" y2="140" stroke="#666" stroke-width="1" stroke-dasharray="4"/>
              <text x="160" y="155" text-anchor="middle" font-size="10" fill="#666">t = 0</text>
              <!-- Pre-treatment coefficients (near zero) -->
              <circle cx="70" cy="88" r="5" fill="#1565c0"/>
              <line x1="70" y1="78" x2="70" y2="98" stroke="#1565c0" stroke-width="2"/>
              <circle cx="100" cy="92" r="5" fill="#1565c0"/>
              <line x1="100" y1="82" x2="100" y2="102" stroke="#1565c0" stroke-width="2"/>
              <circle cx="130" cy="90" r="5" fill="#1565c0"/>
              <line x1="130" y1="80" x2="130" y2="100" stroke="#1565c0" stroke-width="2"/>
              <!-- Reference period (omitted) -->
              <circle cx="160" cy="90" r="5" fill="#999" stroke="#999"/>
              <!-- Post-treatment coefficients (negative effect) -->
              <circle cx="190" cy="115" r="5" fill="#1565c0"/>
              <line x1="190" y1="100" x2="190" y2="130" stroke="#1565c0" stroke-width="2"/>
              <circle cx="220" cy="120" r="5" fill="#1565c0"/>
              <line x1="220" y1="105" x2="220" y2="135" stroke="#1565c0" stroke-width="2"/>
              <circle cx="250" cy="118" r="5" fill="#1565c0"/>
              <line x1="250" y1="103" x2="250" y2="133" stroke="#1565c0" stroke-width="2"/>
              <!-- Y-axis label -->
              <text x="15" y="90" text-anchor="middle" font-size="10" fill="#666" transform="rotate(-90, 15, 90)">Effect</text>
            </svg>
            <div style="font-weight: 600; color: #27ae60; margin-top: 8px;">‚úì Parallel Trends Supported</div>
            <div style="font-size: 0.85em; color: #666;">Pre-treatment coefficients hover around zero with confidence intervals crossing zero.</div>
          </div>
        </div>

        <!-- Bad pre-trends -->
        <div style="text-align: center;">
          <div style="background: #ffebee; border: 2px solid #c62828; border-radius: 8px; padding: 16px;">
            <svg viewBox="0 0 300 180" style="width: 100%; max-width: 280px;">
              <!-- Axes -->
              <line x1="40" y1="140" x2="280" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="20" x2="40" y2="140" stroke="#333" stroke-width="1.5"/>
              <!-- Zero line -->
              <line x1="40" y1="90" x2="280" y2="90" stroke="#c62828" stroke-width="1" stroke-dasharray="4"/>
              <!-- Treatment line -->
              <line x1="160" y1="20" x2="160" y2="140" stroke="#666" stroke-width="1" stroke-dasharray="4"/>
              <text x="160" y="155" text-anchor="middle" font-size="10" fill="#666">t = 0</text>
              <!-- Pre-treatment coefficients (trending!) -->
              <circle cx="70" cy="70" r="5" fill="#c62828"/>
              <line x1="70" y1="55" x2="70" y2="85" stroke="#c62828" stroke-width="2"/>
              <circle cx="100" cy="80" r="5" fill="#c62828"/>
              <line x1="100" y1="65" x2="100" y2="95" stroke="#c62828" stroke-width="2"/>
              <circle cx="130" cy="88" r="5" fill="#c62828"/>
              <line x1="130" y1="73" x2="130" y2="103" stroke="#c62828" stroke-width="2"/>
              <!-- Reference period -->
              <circle cx="160" cy="90" r="5" fill="#999"/>
              <!-- Post-treatment -->
              <circle cx="190" cy="105" r="5" fill="#c62828"/>
              <line x1="190" y1="90" x2="190" y2="120" stroke="#c62828" stroke-width="2"/>
              <circle cx="220" cy="115" r="5" fill="#c62828"/>
              <line x1="220" y1="100" x2="220" y2="130" stroke="#c62828" stroke-width="2"/>
              <circle cx="250" cy="125" r="5" fill="#c62828"/>
              <line x1="250" y1="110" x2="250" y2="140" stroke="#c62828" stroke-width="2"/>
              <!-- Trend arrow -->
              <path d="M 60 65 Q 110 85 145 92" stroke="#c62828" stroke-width="2" fill="none" stroke-dasharray="3"/>
              <text x="85" y="58" font-size="9" fill="#c62828">Pre-trend!</text>
            </svg>
            <div style="font-weight: 600; color: #c62828; margin-top: 8px;">‚úó Pre-Trend Violation</div>
            <div style="font-size: 0.85em; color: #666;">Pre-treatment coefficients trend toward zero‚Äîgroups were already diverging before treatment.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pattern 2: Effect Dynamics -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin: 20px 0;">
      <h4 style="margin-top: 0; color: var(--primary);">2. Understanding Effect Dynamics</h4>
      <p>How the treatment effect evolves over time can reveal important information about the mechanism. Does the policy take time to work? Does the effect persist or fade?</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-top: 20px;">
        <!-- Immediate & constant -->
        <div style="text-align: center;">
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px;">
            <svg viewBox="0 0 200 130" style="width: 100%; max-width: 180px;">
              <line x1="30" y1="100" x2="180" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="15" x2="30" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="60" x2="180" y2="60" stroke="#c62828" stroke-width="1" stroke-dasharray="3"/>
              <line x1="105" y1="15" x2="105" y2="100" stroke="#666" stroke-width="1" stroke-dasharray="3"/>
              <!-- Pre -->
              <circle cx="50" cy="58" r="4" fill="#1565c0"/>
              <circle cx="75" cy="62" r="4" fill="#1565c0"/>
              <circle cx="100" cy="60" r="4" fill="#999"/>
              <!-- Post - immediate jump, stays constant -->
              <circle cx="125" cy="85" r="4" fill="#1565c0"/>
              <circle cx="150" cy="83" r="4" fill="#1565c0"/>
              <circle cx="170" cy="86" r="4" fill="#1565c0"/>
            </svg>
            <div style="font-weight: 600; font-size: 0.9em; margin-top: 6px;">Immediate & Constant</div>
            <div style="font-size: 0.8em; color: #666;">Effect appears right away and persists. Common for price changes, bans.</div>
          </div>
        </div>

        <!-- Growing effect -->
        <div style="text-align: center;">
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px;">
            <svg viewBox="0 0 200 130" style="width: 100%; max-width: 180px;">
              <line x1="30" y1="100" x2="180" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="15" x2="30" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="60" x2="180" y2="60" stroke="#c62828" stroke-width="1" stroke-dasharray="3"/>
              <line x1="105" y1="15" x2="105" y2="100" stroke="#666" stroke-width="1" stroke-dasharray="3"/>
              <!-- Pre -->
              <circle cx="50" cy="58" r="4" fill="#1565c0"/>
              <circle cx="75" cy="62" r="4" fill="#1565c0"/>
              <circle cx="100" cy="60" r="4" fill="#999"/>
              <!-- Post - grows over time -->
              <circle cx="125" cy="70" r="4" fill="#1565c0"/>
              <circle cx="150" cy="80" r="4" fill="#1565c0"/>
              <circle cx="170" cy="92" r="4" fill="#1565c0"/>
              <!-- Arrow showing growth -->
              <path d="M 120 68 L 175 95" stroke="#27ae60" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"/>
            </svg>
            <div style="font-weight: 600; font-size: 0.9em; margin-top: 6px;">Growing Effect</div>
            <div style="font-size: 0.8em; color: #666;">Effect builds over time. Common for education, training, infrastructure.</div>
          </div>
        </div>

        <!-- Fading effect -->
        <div style="text-align: center;">
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px;">
            <svg viewBox="0 0 200 130" style="width: 100%; max-width: 180px;">
              <line x1="30" y1="100" x2="180" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="15" x2="30" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="60" x2="180" y2="60" stroke="#c62828" stroke-width="1" stroke-dasharray="3"/>
              <line x1="105" y1="15" x2="105" y2="100" stroke="#666" stroke-width="1" stroke-dasharray="3"/>
              <!-- Pre -->
              <circle cx="50" cy="58" r="4" fill="#1565c0"/>
              <circle cx="75" cy="62" r="4" fill="#1565c0"/>
              <circle cx="100" cy="60" r="4" fill="#999"/>
              <!-- Post - big initial, fades -->
              <circle cx="125" cy="90" r="4" fill="#1565c0"/>
              <circle cx="150" cy="78" r="4" fill="#1565c0"/>
              <circle cx="170" cy="68" r="4" fill="#1565c0"/>
              <!-- Arrow showing fade -->
              <path d="M 130 92 C 150 85 160 72 172 66" stroke="#f39c12" stroke-width="1.5" fill="none"/>
            </svg>
            <div style="font-weight: 600; font-size: 0.9em; margin-top: 6px;">Fading Effect</div>
            <div style="font-size: 0.8em; color: #666;">Initial impact diminishes. May indicate adaptation or one-time shock.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pattern 3: Anticipation -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin: 20px 0;">
      <h4 style="margin-top: 0; color: var(--primary);">3. Detecting Anticipation Effects</h4>
      <p>Sometimes units respond <em>before</em> the official treatment date‚Äîperhaps because the policy was announced in advance, or because they anticipated it. This shows up as non-zero coefficients just before t=0.</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px;">
        <!-- No anticipation -->
        <div style="text-align: center;">
          <div style="background: #e8f5e9; border: 2px solid #27ae60; border-radius: 8px; padding: 16px;">
            <svg viewBox="0 0 300 180" style="width: 100%; max-width: 280px;">
              <line x1="40" y1="140" x2="280" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="20" x2="40" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="90" x2="280" y2="90" stroke="#c62828" stroke-width="1" stroke-dasharray="4"/>
              <line x1="160" y1="20" x2="160" y2="140" stroke="#666" stroke-width="1" stroke-dasharray="4"/>
              <text x="160" y="155" text-anchor="middle" font-size="10" fill="#666">t = 0 (treatment)</text>
              <!-- Pre-treatment: all near zero -->
              <circle cx="70" cy="92" r="5" fill="#1565c0"/>
              <line x1="70" y1="82" x2="70" y2="102" stroke="#1565c0" stroke-width="2"/>
              <circle cx="100" cy="88" r="5" fill="#1565c0"/>
              <line x1="100" y1="78" x2="100" y2="98" stroke="#1565c0" stroke-width="2"/>
              <circle cx="130" cy="91" r="5" fill="#1565c0"/>
              <line x1="130" y1="81" x2="130" y2="101" stroke="#1565c0" stroke-width="2"/>
              <circle cx="160" cy="90" r="5" fill="#999"/>
              <!-- Sharp jump at t=0 -->
              <circle cx="190" cy="120" r="5" fill="#1565c0"/>
              <line x1="190" y1="108" x2="190" y2="132" stroke="#1565c0" stroke-width="2"/>
              <circle cx="220" cy="118" r="5" fill="#1565c0"/>
              <line x1="220" y1="106" x2="220" y2="130" stroke="#1565c0" stroke-width="2"/>
              <circle cx="250" cy="122" r="5" fill="#1565c0"/>
              <line x1="250" y1="110" x2="250" y2="134" stroke="#1565c0" stroke-width="2"/>
            </svg>
            <div style="font-weight: 600; color: #27ae60; margin-top: 8px;">‚úì Clean Treatment Onset</div>
            <div style="font-size: 0.85em; color: #666;">Effect begins precisely at t=0. No evidence of anticipation.</div>
          </div>
        </div>

        <!-- Anticipation -->
        <div style="text-align: center;">
          <div style="background: #fff3e0; border: 2px solid #f39c12; border-radius: 8px; padding: 16px;">
            <svg viewBox="0 0 300 180" style="width: 100%; max-width: 280px;">
              <line x1="40" y1="140" x2="280" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="20" x2="40" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="90" x2="280" y2="90" stroke="#c62828" stroke-width="1" stroke-dasharray="4"/>
              <line x1="160" y1="20" x2="160" y2="140" stroke="#666" stroke-width="1" stroke-dasharray="4"/>
              <text x="160" y="155" text-anchor="middle" font-size="10" fill="#666">t = 0 (treatment)</text>
              <!-- Pre-treatment: early ones near zero, but t=-2 and t=-1 show effect -->
              <circle cx="70" cy="88" r="5" fill="#1565c0"/>
              <line x1="70" y1="78" x2="70" y2="98" stroke="#1565c0" stroke-width="2"/>
              <circle cx="100" cy="102" r="5" fill="#f39c12"/>
              <line x1="100" y1="92" x2="100" y2="112" stroke="#f39c12" stroke-width="2"/>
              <circle cx="130" cy="112" r="5" fill="#f39c12"/>
              <line x1="130" y1="100" x2="130" y2="124" stroke="#f39c12" stroke-width="2"/>
              <circle cx="160" cy="90" r="5" fill="#999"/>
              <!-- Post -->
              <circle cx="190" cy="120" r="5" fill="#1565c0"/>
              <line x1="190" y1="108" x2="190" y2="132" stroke="#1565c0" stroke-width="2"/>
              <circle cx="220" cy="118" r="5" fill="#1565c0"/>
              <line x1="220" y1="106" x2="220" y2="130" stroke="#1565c0" stroke-width="2"/>
              <circle cx="250" cy="122" r="5" fill="#1565c0"/>
              <line x1="250" y1="110" x2="250" y2="134" stroke="#1565c0" stroke-width="2"/>
              <!-- Label -->
              <text x="115" y="135" font-size="9" fill="#f39c12" font-weight="bold">Anticipation</text>
              <path d="M 100 125 L 100 115" stroke="#f39c12" stroke-width="1.5" marker-end="url(#arrow-orange)"/>
            </svg>
            <div style="font-weight: 600; color: #e67e22; margin-top: 8px;">‚ö† Anticipation Detected</div>
            <div style="font-size: 0.85em; color: #666;">Effect begins before t=0. Units may have responded to announcement or expectation of policy.</div>
          </div>
        </div>
      </div>

      <div class="common-mistakes" style="margin-top: 20px;">
        <h4>What to Do About Anticipation</h4>
        <ul style="margin-bottom: 0;">
          <li><strong>Redefine treatment timing:</strong> If a law was announced 6 months before implementation, use the announcement date as t=0</li>
          <li><strong>Report honestly:</strong> Acknowledging anticipation is better than hiding it‚Äîit may be substantively interesting</li>
          <li><strong>Check the mechanism:</strong> Anticipation can help you understand <em>how</em> the policy works (e.g., through expectations vs. direct effects)</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Event Study Equation -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The event study estimating equation:</div>
    <div style="font-size: 1.1em; text-align: center; padding: 10px;">
      <span style="color: #1565c0;">Y<sub>it</sub></span> =
      <span style="color: #c62828;">Œ£<sub>k‚â†-1</sub> Œ≤<sub>k</sub></span> ¬∑ ùüô[k = t - E<sub>i</sub>] +
      <span style="color: #7b1fa2;">Œ±<sub>i</sub></span> + <span style="color: #00695c;">Œ≥<sub>t</sub></span> + Œµ<sub>it</sub>
    </div>
    <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #1565c0;">‚ñ†</span> Y<sub>it</sub> = outcome</span>
      <span><span style="color: #c62828;">‚ñ†</span> Œ≤<sub>k</sub> = effect k periods from treatment</span>
      <span><span style="color: #666;">‚ñ†</span> E<sub>i</sub> = treatment year for unit i</span>
    </div>
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ccc; text-align: center; font-size: 0.9em;">
      <strong>k = -1 is omitted as the reference period.</strong> Pre-treatment Œ≤<sub>k</sub> (k &lt; -1) should be ‚âà 0 if parallel trends hold.
    </div>
  </div>

  <h3>Setting Up the Variables</h3>
  <p>With staggered treatment (different units treated at different times), you need to create a "time to treatment" variable:</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Create treatment year variable (example: no-fault divorce)
gen treatment_year = .
replace treatment_year = 1970 if state == "CA"
replace treatment_year = 1971 if state == "FL"
* ... etc for each treated state
* Leave as missing for never-treated states (controls)

* Create post-treatment indicator
gen treat_post = (year >= treatment_year) & !missing(treatment_year)

* Create time-to-treatment variable
gen time_to_treat = year - treatment_year
replace time_to_treat = 0 if missing(treatment_year)  // Never-treated = 0

* Stata can't handle negative factor values, so shift
summ time_to_treat
gen shifted_ttt = time_to_treat - r(min)</code></pre>
    <pre class="code-content r"><code class="language-r"># Create treatment year variable
# Never-treated states have NA for treatment_year
data <- data %>%
  mutate(
    treatment_year = case_when(
      state == "CA" ~ 1970,
      state == "FL" ~ 1971,
      # ... etc for each treated state
      TRUE ~ NA_real_  # Never-treated: leave as NA
    ),
    # Binary: ever treated vs never treated
    treated = !is.na(treatment_year),
    # Post-treatment indicator
    treat_post = year >= treatment_year & treated,
    # Time to treatment (for event studies)
    # IMPORTANT: Set never-treated to -1000 (outside data range)
    # Then exclude with ref = c(-1, -1000) in fixest
    time_to_treat = if_else(is.na(treatment_year), -1000, year - treatment_year)
  )</code></pre>
  </div>

  <h3>Basic Event Study</h3>
  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Create relative time to treatment
gen rel_time = year - treatment_year

* Create dummies for each relative time period
* (typically bin endpoints and omit t=-1)
forvalues t = -5/5 {
    gen rel_`t' = (rel_time == `t')
}
replace rel_m5 = (rel_time <= -5)  // Bin early periods
replace rel_5 = (rel_time >= 5)    // Bin late periods

* Regression (omit t=-1 as reference)
reghdfe outcome rel_m5-rel_m2 rel_0-rel_5, ///
    absorb(state year) cluster(state)

* Plot
coefplot, keep(rel_*) vertical yline(0) ///
    xline(3.5, lpattern(dash)) ///
    title("Event Study")</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest, ggfixest, ggplot2, dplyr)

# Create relative time variable
# IMPORTANT: Never-treated units don't have a meaningful "time to treatment"
# Set them to -1000 (outside data range), then exclude with ref = c(-1, -1000)
# See: https://lrberge.github.io/fixest/articles/fixest_walkthrough.html
data <- data %>%
  mutate(
    rel_time = year - treatment_year,
    rel_time = if_else(is.na(rel_time), -1000, rel_time),
    treated = !is.na(treatment_year)
  )

# Optional: bin endpoints to avoid sparse cells (but keep -1000 for never-treated)
data <- data %>%
  mutate(rel_time = case_when(
    rel_time == -1000 ~ -1000,  # Keep never-treated at -1000
    rel_time <= -6 ~ -6,        # Bin early periods
    rel_time >= 6 ~ 6,          # Bin late periods
    TRUE ~ rel_time
  ))

# Event study with fixest
# ref = c(-1, -1000) excludes BOTH t=-1 (reference) AND t=-1000 (never-treated)
model <- feols(
  outcome ~ i(rel_time, treated, ref = c(-1, -1000)) | state + year,
  data = data,
  vcov = ~state
)

# Plot with ggiplot (publication-ready)
p <- ggiplot(model) +
  labs(title = "Event Study",
       x = "Years Relative to Treatment",
       y = "Effect on Outcome") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_vline(xintercept = -0.5, linetype = "dashed", color = "red") +
  theme_minimal()</code></pre>
  </div>

  <div class="callout-info">
    <h4>A Note on Staggered Timing</h4>
    <p>Recent research has found that DiD estimates can be biased when there is both (A) staggered treatment timing and (B) heterogeneous treatment effects. You don't need to know anything about this for 14.33. If you're interested, ask your TA!</p>
  </div>
</section>

<section id="tables" class="tutorial-section">
  <h2>Regression Tables</h2>

  <p>Regression tables present your main results. The standard format in economics shows multiple specifications (columns) with the same outcome variable, progressively adding controls or changing samples. This shows readers how your results change as you adjust the model‚Äîstable coefficients across specifications build confidence in your findings.</p>

  <div class="key-principle">
    <h4>Never Copy Numbers by Hand</h4>
    <p>Export tables directly from your code to LaTeX or Word. Manual copying introduces errors and makes your work non-reproducible. Use <code>estout</code>/<code>esttab</code> in Stata, <code>etable</code>/<code>modelsummary</code> in R, or <code>stargazer</code> in Python.</p>
  </div>

  <h3>Basic Regression Tables</h3>
  <p>Standard elements include: coefficient estimates, standard errors (in parentheses below the coefficient), significance stars, the number of observations, R-squared or other fit statistics, and notes explaining what controls are included.</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Run regressions and store results
eststo clear
eststo: reg income treatment
eststo: reg income treatment age female
eststo: reg income treatment age female education

* Create table
esttab using "regression_table.tex", ///
    se star(* 0.10 ** 0.05 *** 0.01) ///
    label r2 ///
    title("Effect of Treatment on Income") ///
    mtitles("(1)" "(2)" "(3)") ///
    addnotes("Standard errors in parentheses") ///
    replace

* Common options:
*   se           - show standard errors (not t-stats)
*   star(...)    - significance stars
*   label        - use variable labels
*   r2           - show R-squared
*   b(3) se(3)   - 3 decimal places
*   drop(...)    - hide certain coefficients</code></pre>
    <pre class="code-content r"><code class="language-r"># ============================================
# Option 1: etable (from fixest) - simplest
# ============================================
pacman::p_load(fixest)

# Run regressions with feols
m1 <- feols(income ~ treatment, data = data)
m2 <- feols(income ~ treatment + age + female, data = data)
m3 <- feols(income ~ treatment + age + female + education, data = data)

# Quick console table
etable(m1, m2, m3)

# Export to LaTeX
etable(m1, m2, m3, tex = TRUE, file = "regression_table.tex")

# ============================================
# Option 2: modelsummary - most flexible
# ============================================
pacman::p_load(modelsummary)

# Works with any model type (lm, feols, glm, etc.)
m1 <- lm(income ~ treatment, data = data)
m2 <- lm(income ~ treatment + age + female, data = data)
m3 <- lm(income ~ treatment + age + female + education, data = data)

# Create table
modelsummary(
  list("(1)" = m1, "(2)" = m2, "(3)" = m3),
  stars = c('*' = 0.10, '**' = 0.05, '***' = 0.01),
  gof_omit = "AIC|BIC|Log",
  title = "Effect of Treatment on Income"
)

# Export to LaTeX, Word, or HTML
modelsummary(list(m1, m2, m3), output = "table.tex")
modelsummary(list(m1, m2, m3), output = "table.docx")
modelsummary(list(m1, m2, m3), output = "table.html")</code></pre>
    <pre class="code-content python"><code class="language-python">import statsmodels.formula.api as smf
from stargazer.stargazer import Stargazer

# Run regressions
m1 = smf.ols("income ~ treatment", data=data).fit()
m2 = smf.ols("income ~ treatment + age + female", data=data).fit()
m3 = smf.ols("income ~ treatment + age + female + education", data=data).fit()

# Create table with stargazer
stargazer = Stargazer([m1, m2, m3])
stargazer.title("Effect of Treatment on Income")
print(stargazer.render_latex())

# Or manual approach
from statsmodels.iolib.summary2 import summary_col
print(summary_col([m1, m2, m3], stars=True).as_latex())</code></pre>
  </div>

  <div class="key-principle">
    <h4>R Table Packages: Which to Use?</h4>
    <ul style="margin: 8px 0 0;">
      <li><strong>etable</strong> (fixest): Best for quick tables with <code>feols()</code> models. Built into fixest, so no extra dependencies. Great for console output and fast LaTeX export.</li>
      <li><strong>modelsummary</strong>: Most flexible and modern. Works with any model type, exports to LaTeX/Word/HTML/PNG, and has excellent customization. <em>Recommended for publication tables.</em></li>
    </ul>
  </div>

  <h3>Customizing Tables</h3>
  <p>Default table output rarely matches what you need for publication. You'll want to: rename variables, add rows showing which controls or fixed effects are included, report the mean of the dependent variable, and drop unimportant coefficients.</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Add mean of dependent variable
eststo clear
eststo: reg income treatment age female
    estadd local controls "Yes"
    sum income if e(sample)
    estadd scalar mean_y = r(mean)

* Include in table
esttab using "table.tex", ///
    se star(* 0.10 ** 0.05 *** 0.01) ///
    scalars("mean_y Mean of Dep. Var." "controls Controls") ///
    label replace

* Rename coefficients in output
esttab, rename(treatment "Treatment Effect")</code></pre>
    <pre class="code-content r"><code class="language-r"># ----- etable (fixest) customization -----
etable(m1, m2, m3,
  drop = "Constant",           # Hide intercept
  dict = c(treatment = "Treatment Effect"),  # Rename
  extralines = list(
    "_^Controls" = c("No", "Yes", "Yes"),
    "_^Mean of DV" = rep(round(mean(data$income), 2), 3)
  ),
  tex = TRUE, file = "table.tex"
)

# ----- modelsummary customization -----
pacman::p_load(modelsummary, tibble)
rows <- tribble(
  ~term, ~"(1)", ~"(2)", ~"(3)",
  "Controls", "No", "Yes", "Yes",
  "Mean of DV", sprintf("%.2f", mean(data$income)),
                sprintf("%.2f", mean(data$income)),
                sprintf("%.2f", mean(data$income))
)
modelsummary(list(m1, m2, m3),
  add_rows = rows,
  coef_rename = c("treatment" = "Treatment Effect"),
  coef_omit = "Intercept"
)</code></pre>
    <pre class="code-content python"><code class="language-python"># Add custom rows with stargazer
stargazer = Stargazer([m1, m2])
stargazer.add_line("Controls", ["No", "Yes"])
stargazer.add_line("Mean of DV", [f"{data['income'].mean():.2f}"] * 2)
stargazer.rename_covariates({"treatment": "Treatment Effect"})
print(stargazer.render_latex())</code></pre>
  </div>

  <div class="common-mistakes">
    <h4>Table Checklist</h4>
    <ul>
      <li>Do all columns have clear headers?</li>
      <li>Are standard errors in parentheses (not t-stats)?</li>
      <li>Is the dependent variable clearly labeled?</li>
      <li>Are significance levels defined in a note?</li>
      <li>Is sample size reported for each column?</li>
      <li>Are controls indicated (even if not shown)?</li>
    </ul>
  </div>
</section>
