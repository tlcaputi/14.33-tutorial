---
layout: layouts/tutorial.html
title: Causal Inference in Practice | Intro to Data Analysis for Economics
current_page: causal-methods
---
<h1>Causal Inference in Practice</h1>
<p class="subtitle">Instrumental variables, difference-in-differences, event studies, regression discontinuity</p>

<!-- Growth Mindset Message -->
<div class="callout-success">
  <strong>Three Identification Strategies</strong>
  <p style="margin: 8px 0 0;">
    You have three main tools in your toolkit for this class: DiD/Event Studies compare treated and control groups before and after treatment; IV uses an "experiment-like" random shock to your treatment; and RD exploits a threshold or cutoff. Understanding when to use each is key.
  </p>
</div>

<section id="iv" class="tutorial-section">
  <h2>Instrumental Variables</h2>

  <p>Suppose you want to know: <strong>does more education cause higher wages?</strong> You run a regression of wages on years of schooling and find a positive coefficient. But does this mean education <em>causes</em> higher wages?</p>

  <p>The problem is that people who get more education might be different in ways that also affect their wages. Maybe they're smarter, more motivated, or from wealthier families. These traits affect both education <em>and</em> wages. So when you see that educated people earn more, you can't tell if it's because:</p>

  <ul>
    <li>Education actually makes people more productive (the causal effect you want), or</li>
    <li>Smart/motivated people both get more education <em>and</em> earn more (a confound)</li>
  </ul>

  <p>OLS mixes these together. Your coefficient captures both the true effect of education and the fact that "education" is partly a proxy for ability. This is called <strong>omitted variable bias</strong>‚Äîability affects both X and Y, but you can't measure it.</p>

  <div class="callout-info">
    <h4>IV in Practice</h4>
    <ul style="margin: 8px 0 0; padding-left: 18px;">
      <li><strong>Angrist (1990), "Lifetime Earnings and the Vietnam Era Draft Lottery"</strong> <em>AER.</em> Uses the draft lottery number as an instrument for military service. The lottery randomly assigned draft eligibility, creating exogenous variation in who served in Vietnam. <a href="https://doi.org/10.3386/w3514" target="_blank">[Link]</a></li>
      <li><strong>Angrist &amp; Krueger (1991), "Does Compulsory School Attendance Affect Schooling and Earnings?"</strong> <em>QJE.</em> Uses quarter of birth as an instrument for years of schooling. People born earlier in the year can drop out sooner due to compulsory attendance laws, generating exogenous variation in education. <a href="https://doi.org/10.2307/2937954" target="_blank">[Link]</a></li>
      <li><strong>Gruber, Howard, Leder-Luis &amp; Caputi (2025), "Dying or Lying? For-Profit Hospices and End-of-Life Care"</strong> <em>AER.</em> Uses entry of for-profit hospices as an instrument to estimate the causal effect of hospice care on Medicare spending among Alzheimer's and dementia patients, finding that hospice enrollment reduces costs by offsetting more expensive treatments. <a href="https://doi.org/10.1257/aer.20230328" target="_blank">[Link]</a></li>
    </ul>
  </div>

  <h3>The IV Solution</h3>

  <p><strong>Instrumental variables</strong> solve this by finding something that affects education but has no direct effect on wages. This "instrument" creates variation in education that's unrelated to ability.</p>

  <p>A classic example: <strong>distance to the nearest college</strong>. People who grow up closer to a college tend to get more education (it's cheaper and easier to attend). But distance to a college doesn't directly make you earn more‚Äîit only affects wages through its effect on education.</p>

  <p>The logic: if we compare people who differ only in how close they grew up to a college, any wage difference must be due to their different education levels‚Äînot ability, since distance to college isn't correlated with ability.</p>

  <h3>Two-Stage Least Squares (2SLS)</h3>

  <p>In practice, we implement this in two stages:</p>

  <ol>
    <li><strong>First stage:</strong> Predict education using only the instrument (distance to college). This gives us "clean" variation in education that's driven by geography, not ability.</li>
    <li><strong>Second stage:</strong> Use these predicted education values to estimate the effect on wages. Since the predictions are based only on distance, they're uncorrelated with ability.</li>
  </ol>

  <!-- IV Equations -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The two-stage least squares estimating equations:</div>
    <div style="margin-bottom: 16px;">
      <div style="color: #666; font-size: 0.85em; margin-bottom: 4px;">First stage (predict endogenous variable):</div>
      <div style="font-size: 1.1em; text-align: center; padding: 8px; background: #fff; border-radius: 4px;">
        <span style="color: #e65100;">X<sub>i</sub></span> =
        œÄ‚ÇÄ + œÄ‚ÇÅ<span style="color: #1565c0;">Z<sub>i</sub></span> + ŒΩ<sub>i</sub>
      </div>
    </div>
    <div>
      <div style="color: #666; font-size: 0.85em; margin-bottom: 4px;">Second stage (use predicted values):</div>
      <div style="font-size: 1.1em; text-align: center; padding: 8px; background: #fff; border-radius: 4px;">
        <span style="color: #2e7d32;">Y<sub>i</sub></span> =
        Œ≤‚ÇÄ + Œ≤‚ÇÅ<span style="color: #e65100;">XÃÇ<sub>i</sub></span> + Œµ<sub>i</sub>
      </div>
    </div>
    <div style="display: flex; gap: 20px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #2e7d32;">‚ñ†</span> Y = outcome</span>
      <span><span style="color: #e65100;">‚ñ†</span> X = endogenous variable</span>
      <span><span style="color: #1565c0;">‚ñ†</span> Z = instrument</span>
    </div>
  </div>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* 2SLS: Y = outcome, X = endogenous, Z = instrument
* Syntax: ivregress 2sls Y controls (X = Z)

ivregress 2sls income age female (education = distance_to_college)

* First-stage F-statistic (check relevance)
estat firststage

* With robust standard errors
ivregress 2sls income age (education = distance), robust

* With fixed effects
ivreghdfe income age (education = distance), absorb(state) cluster(state)</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest)

# 2SLS with fixest
# Syntax: Y ~ controls | FE | endogenous ~ instrument
model <- feols(income ~ age + female | 0 | education ~ distance_to_college,
               data = data)
summary(model)

# Check first-stage F-statistic
fitstat(model, "ivf")

# With fixed effects
model <- feols(income ~ age | state | education ~ distance,
               data = data, vcov = ~state)</code></pre>
    <pre class="code-content python"><code class="language-python">from linearmodels.iv import IV2SLS
import pandas as pd

# 2SLS: Y = outcome, X = endogenous, Z = instrument
model = IV2SLS.from_formula(
    'income ~ 1 + age + female + [education ~ distance_to_college]',
    data=data
).fit()
print(model.summary)

# First-stage F-statistic
print(f"First-stage F: {model.first_stage.diagnostics['f.stat'].stat:.2f}")

# With robust standard errors
model = IV2SLS.from_formula(
    'income ~ 1 + age + [education ~ distance]',
    data=data
).fit(cov_type='robust')</code></pre>
  </div>

  <h3 id="first-stage">Checking Instrument Strength: First-Stage F-Statistic</h3>
  <p>The first-stage F-statistic tests whether your instrument actually predicts the endogenous variable. Rule of thumb: F > 10 suggests the instrument is strong enough. Weak instruments (F < 10) lead to biased estimates and unreliable inference.</p>

  <div class="key-principle">
    <h4>Instrument Strength Matters</h4>
    <p>Even if your instrument is valid (doesn't affect Y directly), it only helps if it's relevant (actually predicts X). Always report the first-stage F-statistic‚Äîreaders need to know if your instrument is strong.</p>
  </div>

  <h3>Complete IV Example: Protest Size and Voting</h3>
  <p>Research question: Does protest size affect voting? Problem: larger protests might occur in places that would vote differently anyway. Solution: use weather (rain) as an instrument‚Äîrain reduces protest size but shouldn't directly affect voting.</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* First stage: Does rain affect protest size?
reg protest rain, robust
eststo first_stage

* 2SLS: Effect of protest on voting
ivregress 2sls vote (protest = rain), robust
eststo iv_model

* Reduced form: Direct effect of rain on voting
reg vote rain, robust
eststo reduced_form

* Export results
esttab first_stage iv_model reduced_form ///
    using "iv_results.tex", replace ///
    b(3) se(3) star(* 0.10 ** 0.05 *** 0.01) ///
    stats(N r2 F, fmt(%9.0fc %9.3f %9.2f))</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest, modelsummary)

# First stage: Does rain affect protest size?
first_stage <- feols(protest ~ rain, data = data, vcov = "hetero")

# 2SLS: Effect of protest on voting
iv_model <- feols(vote ~ 1 | 0 | protest ~ rain, data = data, vcov = "hetero")

# Reduced form: Direct effect of rain on voting
reduced_form <- feols(vote ~ rain, data = data, vcov = "hetero")

# Export results
modelsummary(
  list("First Stage" = first_stage,
       "2SLS" = iv_model,
       "Reduced Form" = reduced_form),
  stars = c('*' = 0.10, '**' = 0.05, '***' = 0.01),
  output = "iv_results.tex"
)</code></pre>
    <pre class="code-content python"><code class="language-python">import statsmodels.formula.api as smf
from linearmodels.iv import IV2SLS
from stargazer.stargazer import Stargazer

# First stage: Does rain affect protest size?
first_stage = smf.ols('protest ~ rain', data=data).fit(cov_type='HC1')

# 2SLS: Effect of protest on voting
iv_model = IV2SLS.from_formula(
    'vote ~ 1 + [protest ~ rain]', data=data
).fit(cov_type='robust')

# Reduced form: Direct effect of rain on voting
reduced_form = smf.ols('vote ~ rain', data=data).fit(cov_type='HC1')

# Export results
stargazer = Stargazer([first_stage, reduced_form])
stargazer.render_latex()  # or .render_html()</code></pre>
  </div>

  <h3>Common IV Pitfalls</h3>
  <div class="common-mistakes">
    <h4>Watch Out For</h4>
    <ul>
      <li><strong>Weak instruments:</strong> F < 10 means your IV estimates are badly biased toward OLS</li>
      <li><strong>Invalid exclusion:</strong> If the instrument affects Y directly, your estimate is biased</li>
      <li><strong>LATE vs ATE:</strong> IV estimates effects only for "compliers" - this may not generalize</li>
    </ul>
  </div>
</section>

<section id="did" class="tutorial-section">
  <h2>Difference-in-Differences</h2>

  <div class="callout-success">
    <strong>Most students will use DiD/Event Studies for this class.</strong>
  </div>

  <p>Difference-in-differences compares changes over time between a treated group and a control group. The key assumption is that both groups would have followed <strong>parallel trends</strong> in the absence of treatment.</p>

  <div class="callout-info">
    <h4>DiD in Practice</h4>
    <ul style="margin: 8px 0 0; padding-left: 18px;">
      <li><strong>Card &amp; Krueger (1994), "Minimum Wages and Employment: A Case Study of the Fast-Food Industry in New Jersey and Pennsylvania"</strong> <em>AER.</em> Compares employment at fast-food restaurants in NJ (which raised its minimum wage) vs. PA (which didn't). Found no evidence that the minimum wage increase reduced employment‚Äîa result that reshaped the policy debate. <a href="https://doi.org/10.3386/w4509" target="_blank">[Link]</a></li>
      <li><strong>Meinhofer, Witman, Hinde &amp; Simon (2021), "Marijuana Liberalization Policies and Perinatal Health"</strong> <em>Journal of Health Economics.</em> Uses a DiD design to study how state-level marijuana legalization policies affect pregnancy and birth outcomes. <a href="https://doi.org/10.1016/j.jhealeco.2021.102537" target="_blank">[Link]</a></li>
      <li><strong>Braghieri, Levy &amp; Makarin (2022), "Social Media and Mental Health"</strong> <em>AER.</em> Exploits the staggered rollout of Facebook across U.S. college campuses. Compares mental health outcomes at colleges that gained Facebook access to those that hadn't yet, finding that Facebook introduction worsened student mental health. <a href="https://doi.org/10.1257/aer.20211218" target="_blank">[Link]</a></li>
    </ul>
  </div>

  <!-- DiD/TWFE Equation -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The two-way fixed effects (TWFE) estimating equation:</div>
    <div style="font-size: 1.1em; text-align: center; padding: 10px;">
      <span style="color: #1565c0;">Y<sub>it</sub></span> =
      Œ≤‚ÇÄ + <span style="color: #c62828;">Œ≤‚ÇÅ</span>(<span style="color: #2e7d32;">Treat<sub>i</sub></span> √ó <span style="color: #2e7d32;">Post<sub>t</sub></span>) +
      <span style="color: #7b1fa2;">Œ±<sub>i</sub></span> + <span style="color: #00695c;">Œ≥<sub>t</sub></span> + Œµ<sub>it</sub>
    </div>
    <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #1565c0;">‚ñ†</span> Y<sub>it</sub> = outcome</span>
      <span><span style="color: #2e7d32;">‚ñ†</span> Treat √ó Post = 1 if treated and after treatment</span>
      <span><span style="color: #7b1fa2;">‚ñ†</span> Œ±<sub>i</sub> = unit FE</span>
      <span><span style="color: #00695c;">‚ñ†</span> Œ≥<sub>t</sub> = time FE</span>
    </div>
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ccc; text-align: center; font-size: 0.9em;">
      <strong style="color: #c62828;">Œ≤‚ÇÅ is the DiD estimate</strong> ‚Äî the causal effect of treatment
    </div>
  </div>

  <!-- Visual explanation of DiD -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin: 20px 0;">
    <h4 style="margin-top: 0;">The DiD Logic in One Table</h4>
    <table style="width: 100%; border-collapse: collapse; text-align: center; margin: 12px 0;">
      <tr style="background: #e0e0e0;">
        <th style="padding: 12px; border: 1px solid #bdbdbd;"></th>
        <th style="padding: 12px; border: 1px solid #bdbdbd;">Before Treatment</th>
        <th style="padding: 12px; border: 1px solid #bdbdbd;">After Treatment</th>
        <th style="padding: 12px; border: 1px solid #bdbdbd;">Change</th>
      </tr>
      <tr>
        <td style="padding: 12px; border: 1px solid #e0e0e0; font-weight: bold;">Treated (got the policy)</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">A</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">B</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">B - A</td>
      </tr>
      <tr>
        <td style="padding: 12px; border: 1px solid #e0e0e0; font-weight: bold;">Control (no policy)</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">C</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">D</td>
        <td style="padding: 12px; border: 1px solid #e0e0e0;">D - C</td>
      </tr>
      <tr style="background: #e3f2fd;">
        <td style="padding: 12px; border: 1px solid #bbdefb;" colspan="3"><strong>DiD Effect = (B - A) - (D - C)</strong></td>
        <td style="padding: 12px; border: 1px solid #bbdefb;"><strong>Causal effect</strong></td>
      </tr>
    </table>
    <p style="margin: 0; font-size: 0.9em;">
      <strong>Why this works:</strong> The change in the control group (D - C) tells us what would have happened to the treated group without treatment. Subtracting it removes secular trends.
    </p>
  </div>

  <h3>Real-World Example: No-Fault Divorce and Female Suicide</h3>
  <div class="key-principle">
    <h4>Research Question</h4>
    <p>Did the introduction of no-fault divorce laws affect female suicide rates? U.S. states adopted these laws at different times between 1969-1985, creating a natural experiment with staggered treatment timing.</p>
  </div>

  <p>The analysis requires setting up several key variables:</p>
  <ul>
    <li><strong>Treatment year</strong> ‚Äî When each state adopted no-fault divorce</li>
    <li><strong>Post indicator</strong> ‚Äî Whether the current year is after treatment for that state</li>
    <li><strong>Time to treatment</strong> ‚Äî Years before/after treatment (for event studies)</li>
  </ul>

  <h3>Basic 2x2 DiD</h3>
  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Generate treatment indicator
gen treated = (state == "CA")
gen post = (year >= 2015)
gen treat_post = treated * post

* Basic DiD regression
reg outcome treated post treat_post, cluster(state)

* The coefficient on treat_post is the DiD estimate

* Better: Two-way fixed effects
reghdfe outcome treat_post, absorb(state year) cluster(state)

* With controls (like the divorce study)
reghdfe asmrs treat_post pcinc asmrh cases, absorb(stfips year) cluster(stfips)</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest)

# Generate treatment indicator
data <- data %>%
  mutate(
    treated = state == "CA",
    post = year >= 2015,
    treat_post = treated * post
  )

# Basic DiD regression
model <- feols(outcome ~ treated + post + treat_post,
               data = data, vcov = ~state)

# Two-way fixed effects (preferred)
model <- feols(outcome ~ treat_post | state + year,
               data = data, vcov = ~state)

# The treat_post coefficient is the DiD estimate
summary(model)</code></pre>
    <pre class="code-content python"><code class="language-python">import pandas as pd
from linearmodels.panel import PanelOLS

# Generate treatment indicator
data['treated'] = (data['state'] == 'CA').astype(int)
data['post'] = (data['year'] >= 2015).astype(int)
data['treat_post'] = data['treated'] * data['post']

# Basic DiD regression
import statsmodels.formula.api as smf
model = smf.ols('outcome ~ treated + post + treat_post', data=data).fit(
    cov_type='cluster', cov_kwds={'groups': data['state']})

# Two-way fixed effects (preferred)
data_panel = data.set_index(['state', 'year'])
model = PanelOLS.from_formula(
    'outcome ~ treat_post + EntityEffects + TimeEffects',
    data=data_panel
).fit(cov_type='clustered', cluster_entity=True)

print(model.summary)</code></pre>
  </div>

  <h3>Testing Parallel Trends</h3>
  <p>The key assumption is that treated and control groups would have followed parallel trends absent treatment. Check pre-treatment trends:</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Create year dummies interacted with treatment
* (Omit the year before treatment as reference)
reghdfe outcome ib2014.year#treated, ///
    absorb(state year) cluster(state)

* Plot coefficients
coefplot, keep(*#*) vertical ///
    yline(0) xline(4.5, lpattern(dash)) ///
    title("Event Study: Pre-trends Check")</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest, ggfixest, dplyr)

# Create relative time variable
# Set never-treated units to -1000 (outside data range)
data <- data %>%
  mutate(
    rel_time = year - treatment_year,
    rel_time = if_else(is.na(rel_time), -1000, rel_time),
    treated = !is.na(treatment_year)
  )

# Event study regression
# ref = c(-1, -1000) excludes both t=-1 and never-treated (-1000)
model <- feols(
  outcome ~ i(rel_time, treated, ref = c(-1, -1000)) | state + year,
  data = data, vcov = ~state
)

# Plot with ggiplot (publication-ready)
ggiplot(model) +
  labs(title = "Event Study: Pre-trends Check",
       x = "Years Relative to Treatment",
       y = "Coefficient Estimate") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal()</code></pre>
  </div>
</section>

<section id="event-studies" class="tutorial-section">
  <h2>Event Studies</h2>

  <p>Event studies show dynamic treatment effects over time, both before (to check parallel trends) and after treatment. They're essential for:</p>
  <p style="font-size: 0.9em; color: var(--muted);"><strong>R users:</strong> See the <a href="https://lrberge.github.io/fixest/articles/fixest_walkthrough.html" target="_blank">fixest walkthrough</a> for comprehensive documentation on event studies with <code>feols()</code>.</p>
  <ul>
    <li><strong>Testing parallel trends:</strong> Pre-treatment coefficients should be near zero</li>
    <li><strong>Understanding dynamics:</strong> Does the effect grow, shrink, or stay constant over time?</li>
    <li><strong>Detecting anticipation:</strong> Did units respond before official treatment?</li>
  </ul>

  <!-- Visual Examples of Event Study Patterns -->
  <div style="margin: 30px 0;">
    <h3>Reading Event Study Plots</h3>
    <p>Event study coefficients tell a story. Here's how to interpret common patterns:</p>

    <!-- Pattern 1: Parallel Trends -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin: 20px 0;">
      <h4 style="margin-top: 0; color: var(--primary);">1. Testing Parallel Trends</h4>
      <p>Pre-treatment coefficients (before t=0) should be statistically indistinguishable from zero. This suggests treated and control groups were on similar trajectories before treatment.</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px;">
        <!-- Good pre-trends -->
        <div style="text-align: center;">
          <div style="background: #e8f5e9; border: 2px solid #27ae60; border-radius: 8px; padding: 16px;">
            <svg viewBox="0 0 300 180" style="width: 100%; max-width: 280px;">
              <!-- Axes -->
              <line x1="40" y1="140" x2="280" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="20" x2="40" y2="140" stroke="#333" stroke-width="1.5"/>
              <!-- Zero line -->
              <line x1="40" y1="90" x2="280" y2="90" stroke="#c62828" stroke-width="1" stroke-dasharray="4"/>
              <!-- Treatment line -->
              <line x1="160" y1="20" x2="160" y2="140" stroke="#666" stroke-width="1" stroke-dasharray="4"/>
              <text x="160" y="155" text-anchor="middle" font-size="10" fill="#666">t = 0</text>
              <!-- Pre-treatment coefficients (near zero) -->
              <circle cx="70" cy="88" r="5" fill="#1565c0"/>
              <line x1="70" y1="78" x2="70" y2="98" stroke="#1565c0" stroke-width="2"/>
              <circle cx="100" cy="92" r="5" fill="#1565c0"/>
              <line x1="100" y1="82" x2="100" y2="102" stroke="#1565c0" stroke-width="2"/>
              <circle cx="130" cy="90" r="5" fill="#1565c0"/>
              <line x1="130" y1="80" x2="130" y2="100" stroke="#1565c0" stroke-width="2"/>
              <!-- Reference period (omitted) -->
              <circle cx="160" cy="90" r="5" fill="#999" stroke="#999"/>
              <!-- Post-treatment coefficients (negative effect) -->
              <circle cx="190" cy="115" r="5" fill="#1565c0"/>
              <line x1="190" y1="100" x2="190" y2="130" stroke="#1565c0" stroke-width="2"/>
              <circle cx="220" cy="120" r="5" fill="#1565c0"/>
              <line x1="220" y1="105" x2="220" y2="135" stroke="#1565c0" stroke-width="2"/>
              <circle cx="250" cy="118" r="5" fill="#1565c0"/>
              <line x1="250" y1="103" x2="250" y2="133" stroke="#1565c0" stroke-width="2"/>
              <!-- Y-axis label -->
              <text x="15" y="90" text-anchor="middle" font-size="10" fill="#666" transform="rotate(-90, 15, 90)">Effect</text>
            </svg>
            <div style="font-weight: 600; color: #27ae60; margin-top: 8px;">‚úì Parallel Trends Supported</div>
            <div style="font-size: 0.85em; color: #666;">Pre-treatment coefficients hover around zero with confidence intervals crossing zero.</div>
          </div>
        </div>

        <!-- Bad pre-trends -->
        <div style="text-align: center;">
          <div style="background: #ffebee; border: 2px solid #c62828; border-radius: 8px; padding: 16px;">
            <svg viewBox="0 0 300 180" style="width: 100%; max-width: 280px;">
              <!-- Axes -->
              <line x1="40" y1="140" x2="280" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="20" x2="40" y2="140" stroke="#333" stroke-width="1.5"/>
              <!-- Zero line -->
              <line x1="40" y1="90" x2="280" y2="90" stroke="#c62828" stroke-width="1" stroke-dasharray="4"/>
              <!-- Treatment line -->
              <line x1="160" y1="20" x2="160" y2="140" stroke="#666" stroke-width="1" stroke-dasharray="4"/>
              <text x="160" y="155" text-anchor="middle" font-size="10" fill="#666">t = 0</text>
              <!-- Pre-treatment coefficients (trending!) -->
              <circle cx="70" cy="70" r="5" fill="#c62828"/>
              <line x1="70" y1="55" x2="70" y2="85" stroke="#c62828" stroke-width="2"/>
              <circle cx="100" cy="80" r="5" fill="#c62828"/>
              <line x1="100" y1="65" x2="100" y2="95" stroke="#c62828" stroke-width="2"/>
              <circle cx="130" cy="88" r="5" fill="#c62828"/>
              <line x1="130" y1="73" x2="130" y2="103" stroke="#c62828" stroke-width="2"/>
              <!-- Reference period -->
              <circle cx="160" cy="90" r="5" fill="#999"/>
              <!-- Post-treatment -->
              <circle cx="190" cy="105" r="5" fill="#c62828"/>
              <line x1="190" y1="90" x2="190" y2="120" stroke="#c62828" stroke-width="2"/>
              <circle cx="220" cy="115" r="5" fill="#c62828"/>
              <line x1="220" y1="100" x2="220" y2="130" stroke="#c62828" stroke-width="2"/>
              <circle cx="250" cy="125" r="5" fill="#c62828"/>
              <line x1="250" y1="110" x2="250" y2="140" stroke="#c62828" stroke-width="2"/>
              <!-- Trend arrow -->
              <path d="M 60 65 Q 110 85 145 92" stroke="#c62828" stroke-width="2" fill="none" stroke-dasharray="3"/>
              <text x="85" y="58" font-size="9" fill="#c62828">Pre-trend!</text>
            </svg>
            <div style="font-weight: 600; color: #c62828; margin-top: 8px;">‚úó Pre-Trend Violation</div>
            <div style="font-size: 0.85em; color: #666;">Pre-treatment coefficients trend toward zero‚Äîgroups were already diverging before treatment.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pattern 2: Effect Dynamics -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin: 20px 0;">
      <h4 style="margin-top: 0; color: var(--primary);">2. Understanding Effect Dynamics</h4>
      <p>How the treatment effect evolves over time can reveal important information about the mechanism. Does the policy take time to work? Does the effect persist or fade?</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-top: 20px;">
        <!-- Immediate & constant -->
        <div style="text-align: center;">
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px;">
            <svg viewBox="0 0 200 130" style="width: 100%; max-width: 180px;">
              <line x1="30" y1="100" x2="180" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="15" x2="30" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="60" x2="180" y2="60" stroke="#c62828" stroke-width="1" stroke-dasharray="3"/>
              <line x1="105" y1="15" x2="105" y2="100" stroke="#666" stroke-width="1" stroke-dasharray="3"/>
              <!-- Pre -->
              <circle cx="50" cy="58" r="4" fill="#1565c0"/>
              <circle cx="75" cy="62" r="4" fill="#1565c0"/>
              <circle cx="100" cy="60" r="4" fill="#999"/>
              <!-- Post - immediate jump, stays constant -->
              <circle cx="125" cy="85" r="4" fill="#1565c0"/>
              <circle cx="150" cy="83" r="4" fill="#1565c0"/>
              <circle cx="170" cy="86" r="4" fill="#1565c0"/>
            </svg>
            <div style="font-weight: 600; font-size: 0.9em; margin-top: 6px;">Immediate & Constant</div>
            <div style="font-size: 0.8em; color: #666;">Effect appears right away and persists. Common for price changes, bans.</div>
          </div>
        </div>

        <!-- Growing effect -->
        <div style="text-align: center;">
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px;">
            <svg viewBox="0 0 200 130" style="width: 100%; max-width: 180px;">
              <line x1="30" y1="100" x2="180" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="15" x2="30" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="60" x2="180" y2="60" stroke="#c62828" stroke-width="1" stroke-dasharray="3"/>
              <line x1="105" y1="15" x2="105" y2="100" stroke="#666" stroke-width="1" stroke-dasharray="3"/>
              <!-- Pre -->
              <circle cx="50" cy="58" r="4" fill="#1565c0"/>
              <circle cx="75" cy="62" r="4" fill="#1565c0"/>
              <circle cx="100" cy="60" r="4" fill="#999"/>
              <!-- Post - grows over time -->
              <circle cx="125" cy="70" r="4" fill="#1565c0"/>
              <circle cx="150" cy="80" r="4" fill="#1565c0"/>
              <circle cx="170" cy="92" r="4" fill="#1565c0"/>
              <!-- Arrow showing growth -->
              <path d="M 120 68 L 175 95" stroke="#27ae60" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"/>
            </svg>
            <div style="font-weight: 600; font-size: 0.9em; margin-top: 6px;">Growing Effect</div>
            <div style="font-size: 0.8em; color: #666;">Effect builds over time. Common for education, training, infrastructure.</div>
          </div>
        </div>

        <!-- Fading effect -->
        <div style="text-align: center;">
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px;">
            <svg viewBox="0 0 200 130" style="width: 100%; max-width: 180px;">
              <line x1="30" y1="100" x2="180" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="15" x2="30" y2="100" stroke="#333" stroke-width="1"/>
              <line x1="30" y1="60" x2="180" y2="60" stroke="#c62828" stroke-width="1" stroke-dasharray="3"/>
              <line x1="105" y1="15" x2="105" y2="100" stroke="#666" stroke-width="1" stroke-dasharray="3"/>
              <!-- Pre -->
              <circle cx="50" cy="58" r="4" fill="#1565c0"/>
              <circle cx="75" cy="62" r="4" fill="#1565c0"/>
              <circle cx="100" cy="60" r="4" fill="#999"/>
              <!-- Post - big initial, fades -->
              <circle cx="125" cy="90" r="4" fill="#1565c0"/>
              <circle cx="150" cy="78" r="4" fill="#1565c0"/>
              <circle cx="170" cy="68" r="4" fill="#1565c0"/>
              <!-- Arrow showing fade -->
              <path d="M 130 92 C 150 85 160 72 172 66" stroke="#f39c12" stroke-width="1.5" fill="none"/>
            </svg>
            <div style="font-weight: 600; font-size: 0.9em; margin-top: 6px;">Fading Effect</div>
            <div style="font-size: 0.8em; color: #666;">Initial impact diminishes. May indicate adaptation or one-time shock.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pattern 3: Anticipation -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin: 20px 0;">
      <h4 style="margin-top: 0; color: var(--primary);">3. Detecting Anticipation Effects</h4>
      <p>Sometimes units respond <em>before</em> the official treatment date‚Äîperhaps because the policy was announced in advance, or because they anticipated it. This shows up as non-zero coefficients just before t=0.</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px;">
        <!-- No anticipation -->
        <div style="text-align: center;">
          <div style="background: #e8f5e9; border: 2px solid #27ae60; border-radius: 8px; padding: 16px;">
            <svg viewBox="0 0 300 180" style="width: 100%; max-width: 280px;">
              <line x1="40" y1="140" x2="280" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="20" x2="40" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="90" x2="280" y2="90" stroke="#c62828" stroke-width="1" stroke-dasharray="4"/>
              <line x1="160" y1="20" x2="160" y2="140" stroke="#666" stroke-width="1" stroke-dasharray="4"/>
              <text x="160" y="155" text-anchor="middle" font-size="10" fill="#666">t = 0 (treatment)</text>
              <!-- Pre-treatment: all near zero -->
              <circle cx="70" cy="92" r="5" fill="#1565c0"/>
              <line x1="70" y1="82" x2="70" y2="102" stroke="#1565c0" stroke-width="2"/>
              <circle cx="100" cy="88" r="5" fill="#1565c0"/>
              <line x1="100" y1="78" x2="100" y2="98" stroke="#1565c0" stroke-width="2"/>
              <circle cx="130" cy="91" r="5" fill="#1565c0"/>
              <line x1="130" y1="81" x2="130" y2="101" stroke="#1565c0" stroke-width="2"/>
              <circle cx="160" cy="90" r="5" fill="#999"/>
              <!-- Sharp jump at t=0 -->
              <circle cx="190" cy="120" r="5" fill="#1565c0"/>
              <line x1="190" y1="108" x2="190" y2="132" stroke="#1565c0" stroke-width="2"/>
              <circle cx="220" cy="118" r="5" fill="#1565c0"/>
              <line x1="220" y1="106" x2="220" y2="130" stroke="#1565c0" stroke-width="2"/>
              <circle cx="250" cy="122" r="5" fill="#1565c0"/>
              <line x1="250" y1="110" x2="250" y2="134" stroke="#1565c0" stroke-width="2"/>
            </svg>
            <div style="font-weight: 600; color: #27ae60; margin-top: 8px;">‚úì Clean Treatment Onset</div>
            <div style="font-size: 0.85em; color: #666;">Effect begins precisely at t=0. No evidence of anticipation.</div>
          </div>
        </div>

        <!-- Anticipation -->
        <div style="text-align: center;">
          <div style="background: #fff3e0; border: 2px solid #f39c12; border-radius: 8px; padding: 16px;">
            <svg viewBox="0 0 300 180" style="width: 100%; max-width: 280px;">
              <line x1="40" y1="140" x2="280" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="20" x2="40" y2="140" stroke="#333" stroke-width="1.5"/>
              <line x1="40" y1="90" x2="280" y2="90" stroke="#c62828" stroke-width="1" stroke-dasharray="4"/>
              <line x1="160" y1="20" x2="160" y2="140" stroke="#666" stroke-width="1" stroke-dasharray="4"/>
              <text x="160" y="155" text-anchor="middle" font-size="10" fill="#666">t = 0 (treatment)</text>
              <!-- Pre-treatment: early ones near zero, but t=-2 and t=-1 show effect -->
              <circle cx="70" cy="88" r="5" fill="#1565c0"/>
              <line x1="70" y1="78" x2="70" y2="98" stroke="#1565c0" stroke-width="2"/>
              <circle cx="100" cy="102" r="5" fill="#f39c12"/>
              <line x1="100" y1="92" x2="100" y2="112" stroke="#f39c12" stroke-width="2"/>
              <circle cx="130" cy="112" r="5" fill="#f39c12"/>
              <line x1="130" y1="100" x2="130" y2="124" stroke="#f39c12" stroke-width="2"/>
              <circle cx="160" cy="90" r="5" fill="#999"/>
              <!-- Post -->
              <circle cx="190" cy="120" r="5" fill="#1565c0"/>
              <line x1="190" y1="108" x2="190" y2="132" stroke="#1565c0" stroke-width="2"/>
              <circle cx="220" cy="118" r="5" fill="#1565c0"/>
              <line x1="220" y1="106" x2="220" y2="130" stroke="#1565c0" stroke-width="2"/>
              <circle cx="250" cy="122" r="5" fill="#1565c0"/>
              <line x1="250" y1="110" x2="250" y2="134" stroke="#1565c0" stroke-width="2"/>
              <!-- Label -->
              <text x="115" y="135" font-size="9" fill="#f39c12" font-weight="bold">Anticipation</text>
              <path d="M 100 125 L 100 115" stroke="#f39c12" stroke-width="1.5" marker-end="url(#arrow-orange)"/>
            </svg>
            <div style="font-weight: 600; color: #e67e22; margin-top: 8px;">‚ö† Anticipation Detected</div>
            <div style="font-size: 0.85em; color: #666;">Effect begins before t=0. Units may have responded to announcement or expectation of policy.</div>
          </div>
        </div>
      </div>

      <div class="common-mistakes" style="margin-top: 20px;">
        <h4>What to Do About Anticipation</h4>
        <ul style="margin-bottom: 0;">
          <li><strong>Redefine treatment timing:</strong> If a law was announced 6 months before implementation, use the announcement date as t=0</li>
          <li><strong>Report honestly:</strong> Acknowledging anticipation is better than hiding it‚Äîit may be substantively interesting</li>
          <li><strong>Check the mechanism:</strong> Anticipation can help you understand <em>how</em> the policy works (e.g., through expectations vs. direct effects)</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Event Study Equation -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The event study estimating equation:</div>
    <div style="font-size: 1.1em; text-align: center; padding: 10px;">
      <span style="color: #1565c0;">Y<sub>it</sub></span> =
      <span style="color: #c62828;">Œ£<sub>k‚â†-1</sub> Œ≤<sub>k</sub></span> ¬∑ ùüô[k = t - E<sub>i</sub>] +
      <span style="color: #7b1fa2;">Œ±<sub>i</sub></span> + <span style="color: #00695c;">Œ≥<sub>t</sub></span> + Œµ<sub>it</sub>
    </div>
    <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #1565c0;">‚ñ†</span> Y<sub>it</sub> = outcome</span>
      <span><span style="color: #c62828;">‚ñ†</span> Œ≤<sub>k</sub> = effect k periods from treatment</span>
      <span><span style="color: #666;">‚ñ†</span> E<sub>i</sub> = treatment year for unit i</span>
    </div>
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ccc; text-align: center; font-size: 0.9em;">
      <strong>k = -1 is omitted as the reference period.</strong> Pre-treatment Œ≤<sub>k</sub> (k &lt; -1) should be ‚âà 0 if parallel trends hold.
    </div>
  </div>

  <h3>Setting Up the Variables</h3>
  <p>With staggered treatment (different units treated at different times), you need to create a "time to treatment" variable:</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Create treatment year variable (example: no-fault divorce)
gen treatment_year = .
replace treatment_year = 1970 if state == "CA"
replace treatment_year = 1971 if state == "FL"
* ... etc for each treated state
* Leave as missing for never-treated states (controls)

* Create post-treatment indicator
gen treat_post = (year >= treatment_year) & !missing(treatment_year)

* Create time-to-treatment variable
gen time_to_treat = year - treatment_year
replace time_to_treat = 0 if missing(treatment_year)  // Never-treated = 0

* Stata can't handle negative factor values, so shift
summ time_to_treat
gen shifted_ttt = time_to_treat - r(min)</code></pre>
    <pre class="code-content r"><code class="language-r"># Create treatment year variable
# Never-treated states have NA for treatment_year
data <- data %>%
  mutate(
    treatment_year = case_when(
      state == "CA" ~ 1970,
      state == "FL" ~ 1971,
      # ... etc for each treated state
      TRUE ~ NA_real_  # Never-treated: leave as NA
    ),
    # Binary: ever treated vs never treated
    treated = !is.na(treatment_year),
    # Post-treatment indicator
    treat_post = year >= treatment_year & treated,
    # Time to treatment (for event studies)
    # IMPORTANT: Set never-treated to -1000 (outside data range)
    # Then exclude with ref = c(-1, -1000) in fixest
    time_to_treat = if_else(is.na(treatment_year), -1000, year - treatment_year)
  )</code></pre>
  </div>

  <h3>Basic Event Study</h3>
  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Create relative time to treatment
gen rel_time = year - treatment_year

* Create dummies for each relative time period
* (typically bin endpoints and omit t=-1)
forvalues t = -5/5 {
    gen rel_`t' = (rel_time == `t')
}
replace rel_m5 = (rel_time <= -5)  // Bin early periods
replace rel_5 = (rel_time >= 5)    // Bin late periods

* Regression (omit t=-1 as reference)
reghdfe outcome rel_m5-rel_m2 rel_0-rel_5, ///
    absorb(state year) cluster(state)

* Plot
coefplot, keep(rel_*) vertical yline(0) ///
    xline(3.5, lpattern(dash)) ///
    title("Event Study")</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest, ggfixest, ggplot2, dplyr)

# Create relative time variable
# IMPORTANT: Never-treated units don't have a meaningful "time to treatment"
# Set them to -1000 (outside data range), then exclude with ref = c(-1, -1000)
# See: https://lrberge.github.io/fixest/articles/fixest_walkthrough.html
data <- data %>%
  mutate(
    rel_time = year - treatment_year,
    rel_time = if_else(is.na(rel_time), -1000, rel_time),
    treated = !is.na(treatment_year)
  )

# Optional: bin endpoints to avoid sparse cells (but keep -1000 for never-treated)
data <- data %>%
  mutate(rel_time = case_when(
    rel_time == -1000 ~ -1000,  # Keep never-treated at -1000
    rel_time <= -6 ~ -6,        # Bin early periods
    rel_time >= 6 ~ 6,          # Bin late periods
    TRUE ~ rel_time
  ))

# Event study with fixest
# ref = c(-1, -1000) excludes BOTH t=-1 (reference) AND t=-1000 (never-treated)
model <- feols(
  outcome ~ i(rel_time, treated, ref = c(-1, -1000)) | state + year,
  data = data,
  vcov = ~state
)

# Plot with ggiplot (publication-ready)
ggiplot(model) +
  labs(title = "Event Study",
       x = "Years Relative to Treatment",
       y = "Effect on Outcome") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_vline(xintercept = -0.5, linetype = "dashed", color = "red") +
  theme_minimal()</code></pre>
  </div>

  <div class="callout-info">
    <h4>A Note on Staggered Timing</h4>
    <p>Recent research has found that DiD estimates can be biased when there is both (A) staggered treatment timing and (B) heterogeneous treatment effects. You don't need to know anything about this for 14.33. If you're interested, ask your TA!</p>
  </div>
</section>

<section id="rd" class="tutorial-section">
  <h2>Regression Discontinuity</h2>

  <p>Regression discontinuity (RD) exploits a sharp threshold‚Äîa cutoff rule that determines who gets treated. When treatment is assigned based on whether someone crosses a threshold (e.g., a test score, age, income level), you can compare outcomes for people just barely above and just barely below the cutoff. These nearly-identical groups differ only in treatment status, creating a quasi-experimental setting.</p>

  <div class="callout-info">
    <h4>RD in Practice</h4>
    <ul style="margin: 8px 0 0; padding-left: 18px;">
      <li><strong>Almond, Doyle, Kowalski &amp; Williams (2010), "Estimating Marginal Returns to Medical Care: Evidence from At-risk Newborns"</strong> <em>QJE.</em> Exploits the "very low birth weight" (VLBW) classification at 1,500 grams. Newborns just below this cutoff receive substantially more medical care, allowing the authors to estimate whether the extra treatment improves infant health outcomes. <a href="https://doi.org/10.1162/qjec.2010.125.2.591" target="_blank">[Link]</a></li>
      <li><strong>Almond &amp; Doyle (2011), "After Midnight: A Regression Discontinuity Design in Length of Postpartum Hospital Stays"</strong> <em>AEJ: Economic Policy.</em> Uses the midnight births cutoff: babies born just after midnight get counted as a new hospital day, leading to longer postpartum stays than babies born just before midnight. This discontinuity in hospital stay length lets them estimate the effect of extra hospital time on newborn health. <a href="https://doi.org/10.1257/pol.3.3.1" target="_blank">[Link]</a></li>
    </ul>
  </div>

  <h3>The RD Idea in One Picture</h3>
  <p>Imagine a college admissions test where anyone with a score ‚â• 80 gets in, and anyone with a score < 80 is rejected. People with scores of 80 and 79 are nearly identical in ability, but vastly different in college attendance. If college causes higher earnings, we should see a jump in earnings right at the 80 cutoff.</p>

  <!-- RD Equation -->
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
    <div style="color: #666; margin-bottom: 8px;">The sharp RD estimating equation:</div>
    <div style="font-size: 1.1em; text-align: center; padding: 10px;">
      <span style="color: #1565c0;">Y<sub>i</sub></span> =
      Œ≤‚ÇÄ + <span style="color: #c62828;">Œ≤‚ÇÅ</span><span style="color: #2e7d32;">Treat<sub>i</sub></span> +
      f(<span style="color: #7b1fa2;">X<sub>i</sub></span>) + Œµ<sub>i</sub>
    </div>
    <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.85em; flex-wrap: wrap; justify-content: center;">
      <span><span style="color: #1565c0;">‚ñ†</span> Y<sub>i</sub> = outcome</span>
      <span><span style="color: #2e7d32;">‚ñ†</span> Treat<sub>i</sub> = 1 if above cutoff</span>
      <span><span style="color: #7b1fa2;">‚ñ†</span> X<sub>i</sub> = running variable (test score)</span>
    </div>
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ccc; text-align: center; font-size: 0.9em;">
      <strong style="color: #c62828;">Œ≤‚ÇÅ is the RD estimate</strong> ‚Äî the causal effect at the cutoff
    </div>
  </div>

  <h3>Why RD Works</h3>
  <p>At the cutoff, treatment is essentially random. Someone with a test score of 79.9 has nearly the same ability as someone with 80.1, but their treatment status flips. By comparing outcomes just above and below the cutoff, you isolate the effect of treatment from all the underlying characteristics that typically confound it (ability, motivation, socioeconomic status).</p>

  <div class="key-principle">
    <h4>The Cutoff Is Key</h4>
    <p>RD validity depends on the running variable being continuous and manipulation being impossible. For example: you can't improve your age (it's continuous and manipulation is impossible), but you could game a test score (it's discrete and manipulation is possible). The closer you are to the cutoff, the more convincing the design.</p>
  </div>

  <h3>Implementation: Simple Local Linear Regression</h3>
  <p>The simplest approach: fit a line on each side of the cutoff using observations near the cutoff, then compute the gap where the lines meet.</p>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
        <button class="code-tab" data-lang="python">Python</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Create treatment indicator based on cutoff
gen cutoff = 80
gen treated = (test_score >= cutoff)

* Simple RD: linear regression on each side
reg outcome test_score treated if test_score < cutoff + 10 & test_score > cutoff - 10

* Better: allow different slopes on each side
gen score_centered = test_score - cutoff
reg outcome treated score_centered c.score_centered#treated if abs(score_centered) <= 10

* Or use rdrobust (requires installation)
ssc install rdrobust
rdrobust outcome test_score, c(80) h(10)</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(tidyverse, rdrobust)

# Create treatment indicator
data <- data %>%
  mutate(
    cutoff = 80,
    treated = test_score >= cutoff,
    score_centered = test_score - cutoff
  )

# Simple RD: fit lines on each side of cutoff
library(fixest)
model <- feols(
  outcome ~ treated + score_centered + treated:score_centered,
  data = data %>% filter(abs(score_centered) <= 10)
)
summary(model)

# Or use rdrobust for optimal bandwidth selection
rd_result <- rdrobust(
  y = data$outcome,
  x = data$test_score,
  c = 80  # cutoff
)
summary(rd_result)</code></pre>
    <pre class="code-content python"><code class="language-python">import numpy as np
import pandas as pd
import statsmodels.formula.api as smf
from sklearn.linear_model import LinearRegression

# Create treatment indicator
data['cutoff'] = 80
data['treated'] = (data['test_score'] >= data['cutoff']).astype(int)
data['score_centered'] = data['test_score'] - data['cutoff']

# Simple RD: fit lines on each side, then find gap at cutoff
# Below cutoff
below = data[data['score_centered'] < 0]
model_below = smf.ols('outcome ~ score_centered', data=below).fit()

# Above cutoff
above = data[data['score_centered'] >= 0]
model_above = smf.ols('outcome ~ score_centered', data=above).fit()

# Predictions at cutoff (score_centered = 0)
pred_below = model_below.predict(pd.DataFrame({'score_centered': [0]})).values[0]
pred_above = model_above.predict(pd.DataFrame({'score_centered': [0]})).values[0]
rd_estimate = pred_above - pred_below

# Or use bandwidth restriction
window = 10
window_data = data[np.abs(data['score_centered']) <= window]
model = smf.ols('outcome ~ treated + score_centered + treated:score_centered',
                 data=window_data).fit()
print(f"RD Estimate: {model.params['treated']:.4f}")</code></pre>
  </div>

  <h3>Checking RD Validity</h3>
  <p>RD is only convincing if people can't precisely manipulate the running variable to cross the threshold. Check for:</p>

  <ul>
    <li><strong>Continuity at cutoff:</strong> Is there a discontinuous jump in the density of observations at the cutoff? (If yes, people may be manipulating.)</li>
    <li><strong>Covariate balance:</strong> Do pre-determined characteristics (e.g., age, parental education) show a discontinuity at the cutoff? (If yes, confounders may be driving the result.)</li>
    <li><strong>Placebo tests:</strong> Try the same RD design on outcomes that shouldn't be affected by treatment. If you find effects, something is wrong with your design.</li>
  </ul>

  <div class="code-block">
    <div class="code-header">
      <div class="code-tabs">
        <button class="code-tab active" data-lang="stata">Stata</button>
        <button class="code-tab" data-lang="r">R</button>
      </div>
      <button class="copy-btn" onclick="copyCode(this)">Copy</button>
    </div>
    <pre class="code-content stata active"><code class="language-stata">* Test covariate balance: does age jump at cutoff?
reg age treated score_centered c.score_centered#treated ///
    if abs(score_centered) <= 10

* If the coefficient on 'treated' is near zero,
* age is balanced (good for validity)

* Placebo test: effect on a variable that shouldn't be affected
reg parental_education treated score_centered c.score_centered#treated ///
    if abs(score_centered) <= 10

* Density check: are observations bunched above cutoff?
hist test_score if abs(score_centered) <= 5, by(treated)</code></pre>
    <pre class="code-content r"><code class="language-r">pacman::p_load(fixest, ggplot2)

# Check covariate balance: does age jump at cutoff?
balance_model <- feols(
  age ~ treated + score_centered + treated:score_centered,
  data = data %>% filter(abs(score_centered) <= 10)
)
summary(balance_model)

# If treated coefficient ‚âà 0, age is balanced (good)

# Placebo test on variable unaffected by treatment
placebo_model <- feols(
  parental_education ~ treated + score_centered + treated:score_centered,
  data = data %>% filter(abs(score_centered) <= 10)
)
summary(placebo_model)

# Density check: histogram of running variable
ggplot(data %>% filter(abs(score_centered) <= 5),
       aes(x = test_score, fill = treated)) +
  geom_histogram(bins = 20, alpha = 0.5) +
  geom_vline(xintercept = 80, linetype = "dashed") +
  theme_minimal() +
  labs(title = "Density Check: Bunching at Cutoff?")</code></pre>
  </div>

  <h3>Bandwidth Selection</h3>
  <p>How close to the cutoff should you focus? Too close, and you have few observations and less precision. Too far, and people further from the cutoff may not be comparable. The rule of thumb: use observations within 1-2 standard deviations of the running variable, or use automated bandwidth selection (like rdrobust does).</p>

  <div class="callout-warning">
    <h4>RD Estimates Local Effects</h4>
    <p>RD identifies the effect for people <em>at the cutoff</em>. This is the "local average treatment effect" (LATE). If people far from the cutoff would have very different treatment effects, RD won't tell you about those groups. Always be clear about whom your results apply to.</p>
  </div>
</section>
